<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“ å¢å¼ºç‰ˆè‰è“è¯†åˆ«ç›‘æ§ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #48ca48 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto 1fr;
            gap: 20px;
            min-height: 100vh;
        }

        .header {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            text-align: center;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48ca48);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ed573;
        }

        .status-dot.warning {
            background: #ffa502;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .panel-title {
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
        }

        .panel-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        /* ä¼ æ„Ÿå™¨é¢æ¿ */
        .sensors-panel {
            grid-column: 1;
            grid-row: 2;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            flex-grow: 1;
        }

        .sensor-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .sensor-card.optimal {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .sensor-card.good {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }

        .sensor-card.warning {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .sensor-card.danger {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .sensor-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .sensor-name {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .sensor-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .sensor-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.7);
        }

        /* é€šç”¨æ£€æµ‹é¢æ¿ */
        .detection-panel {
            grid-column: 2;
            grid-row: 2;
        }

        /* ğŸ“ è‰è“æ£€æµ‹é¢æ¿ */
        .strawberry-panel {
            grid-column: 3;
            grid-row: 2;
            border: 3px solid #ff6b6b;
        }

        .strawberry-panel .panel-title {
            color: #ff6b6b;
        }

        .strawberry-panel .panel-badge {
            background: #ff6b6b;
        }

        .video-container {
            flex-grow: 1;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-frame {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
        }

        .detection-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .detection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease;
        }

        .stat-item:hover {
            transform: scale(1.05);
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }

        /* ğŸ¯ é€šç”¨æ£€æµ‹ç±»åˆ«ç»Ÿè®¡æ ·å¼ */
        .object-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .object-category-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.2s ease;
            position: relative;
        }

        .object-category-item:hover {
            transform: scale(1.05);
        }

        .object-category-item.person {
            border-color: #fd79a8;
            background: linear-gradient(135deg, #ffeef4 0%, #fdd8e7 100%);
        }

        .object-category-item.car {
            border-color: #74b9ff;
            background: linear-gradient(135deg, #e6f3ff 0%, #cce7ff 100%);
        }

        .object-category-item.bottle {
            border-color: #00b894;
            background: linear-gradient(135deg, #e6f7f3 0%, #ccf0e6 100%);
        }

        .object-category-item.chair {
            border-color: #e17055;
            background: linear-gradient(135deg, #fdf2f0 0%, #fbe5e1 100%);
        }

        .object-category-item.phone {
            border-color: #a29bfe;
            background: linear-gradient(135deg, #f4f3ff 0%, #e9e6ff 100%);
        }

        .object-category-item.book {
            border-color: #fdcb6e;
            background: linear-gradient(135deg, #fffbf0 0%, #fff2d9 100%);
        }

        .object-category-item.laptop {
            border-color: #6c5ce7;
            background: linear-gradient(135deg, #f1f0ff 0%, #e2e0ff 100%);
        }

        .object-category-item.common {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f1ff 0%, #e0e3ff 100%);
        }

        .category-icon {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .category-name {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .category-count {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .no-detections {
            grid-column: 1 / -1;
        }

        /* ğŸ“ è‰è“ç‰¹æ®Šæ ·å¼ */
        .strawberry-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .strawberry-stat-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .strawberry-stat-item.ripe {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .strawberry-stat-item.nearly-ripe {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .strawberry-stat-item.unripe {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }

        .strawberry-stat-item.rotten {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .strawberry-stat-item.harvest {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #ffecec 0%, #ffd3d3 100%);
        }

        .strawberry-stat-item.quality {
            border-color: #48ca48;
            background: linear-gradient(135deg, #e8f5e8 0%, #d1f2d1 100%);
        }

        /* è‰è“æ§åˆ¶æŒ‰é’® */
        .strawberry-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .strawberry-toggle {
            padding: 8px 15px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .strawberry-toggle:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .strawberry-toggle:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* AI å¯¹è¯é¢æ¿ */
        .ai-panel {
            grid-column: 1 / -1;
            grid-row: 3;
            max-height: 600px;
        }

        .ai-config {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .ai-config input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            flex: 1;
            min-width: 200px;
        }

        .ai-config button {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .ai-config button:hover {
            background: #5a6fd8;
        }

        .ai-config button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .chat-container {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            min-height: 400px;
        }

        .chat-messages {
            flex: 2;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            background: #fafafa;
            max-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: white;
            border: 1px solid #e9ecef;
        }

        .message.system {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #666;
            font-style: italic;
            text-align: center;
            max-width: 100%;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input-container {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .chat-send {
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .chat-send:hover {
            background: #218838;
        }

        .chat-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .system-info {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-title {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }

        .info-list {
            list-style: none;
        }

        .info-list li {
            padding: 5px 0;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-list li:last-child {
            border-bottom: none;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #667eea;
        }

        .loading-dots {
            display: flex;
            gap: 3px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #667eea;
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto auto;
            }

            .sensors-panel {
                grid-column: 1;
                grid-row: 2;
            }

            .detection-panel {
                grid-column: 2;
                grid-row: 2;
            }

            .strawberry-panel {
                grid-column: 1 / -1;
                grid-row: 3;
            }

            .ai-panel {
                grid-column: 1 / -1;
                grid-row: 4;
            }
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto auto;
            }

            .sensors-panel, .detection-panel, .strawberry-panel {
                grid-column: 1;
            }

            .sensors-panel { grid-row: 2; }
            .detection-panel { grid-row: 3; }
            .strawberry-panel { grid-row: 4; }
            .ai-panel { grid-row: 5; }

            .chat-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨çŠ¶æ€æ  -->
        <div class="header">
            <h1>ğŸ“ å¢å¼ºç‰ˆè‰è“è¯†åˆ«ç›‘æ§ç³»ç»Ÿ - å®Œæ•´ç‰ˆ</h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="mqttStatus"></div>
                    <span>MQTT: <span id="mqttText">æœªè¿æ¥</span></span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="cameraStatus"></div>
                    <span>ç›¸æœº: <span id="cameraText">ç¦»çº¿</span></span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="detectionStatus"></div>
                    <span>é€šç”¨æ£€æµ‹: <span id="detectionText">å¾…æœº</span></span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="strawberryStatus"></div>
                    <span>ğŸ“æ£€æµ‹: <span id="strawberryText">å¾…æœº</span></span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="aiStatus"></div>
                    <span>AI: <span id="aiText">æœªè¿æ¥</span></span>
                </div>
                <div class="status-item">
                    <span>è¿è¡Œæ—¶é—´: <span id="uptime">00:00:00</span></span>
                </div>
            </div>
        </div>

        <!-- ä¼ æ„Ÿå™¨é¢æ¿ -->
        <div class="panel sensors-panel">
            <div class="panel-header">
                <div class="panel-title">ğŸ“Š ä¼ æ„Ÿå™¨ç›‘æ§</div>
                <div class="panel-badge" id="sensorBadge">ç­‰å¾…æ•°æ®</div>
            </div>
            <div class="sensor-grid">
                <div class="sensor-card" id="temperatureCard">
                    <div class="sensor-icon">ğŸŒ¡ï¸</div>
                    <div class="sensor-name">æ¸©åº¦</div>
                    <div class="sensor-value" id="temperatureValue">--</div>
                    <div class="sensor-status" id="temperatureStatus">ç­‰å¾…æ•°æ®</div>
                </div>
                <div class="sensor-card" id="humidityCard">
                    <div class="sensor-icon">ğŸ’§</div>
                    <div class="sensor-name">æ¹¿åº¦</div>
                    <div class="sensor-value" id="humidityValue">--</div>
                    <div class="sensor-status" id="humidityStatus">ç­‰å¾…æ•°æ®</div>
                </div>
                <div class="sensor-card" id="lightCard">
                    <div class="sensor-icon">â˜€ï¸</div>
                    <div class="sensor-name">å…‰ç…§</div>
                    <div class="sensor-value" id="lightValue">--</div>
                    <div class="sensor-status" id="lightStatus">ç­‰å¾…æ•°æ®</div>
                </div>
            </div>
        </div>

        <!-- é€šç”¨æ£€æµ‹é¢æ¿ -->
        <div class="panel detection-panel">
            <div class="panel-header">
                <div class="panel-title">ğŸ¯ é€šç”¨ç‰©ä½“æ£€æµ‹</div>
                <div class="panel-badge" id="detectionBadge">å¾…æœº</div>
            </div>

            <div class="video-container">
                <img id="videoFrame" class="video-frame" style="display: none;" alt="æ£€æµ‹ç”»é¢">
                <div id="videoPlaceholder" style="color: white; text-align: center;">
                    <div style="font-size: 36px; margin-bottom: 15px;">ğŸ“·</div>
                    <div>ç­‰å¾…å›¾åƒæ•°æ®...</div>
                </div>
                <div class="video-overlay" id="videoOverlay" style="display: none;">
                    <div id="frameInfo">Frame: 0</div>
                    <div id="detectionCount">æ£€æµ‹: 0 ä¸ªç‰©ä½“</div>
                </div>
            </div>

            <div class="detection-info">
                <!-- åŸºç¡€ç»Ÿè®¡ -->
                <div class="detection-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalDetections">0</div>
                        <div class="stat-label">æ€»æ£€æµ‹æ•°</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentDetections">0</div>
                        <div class="stat-label">å½“å‰æ£€æµ‹</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="processingTime">0.00s</div>
                        <div class="stat-label">å¤„ç†æ—¶é—´</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentImage">--</div>
                        <div class="stat-label">å½“å‰å›¾ç‰‡</div>
                    </div>
                </div>

                <!-- ğŸ¯ æ£€æµ‹ç±»åˆ«ç»Ÿè®¡ -->
                <div style="margin-top: 15px;">
                    <div style="font-size: 14px; font-weight: 600; color: #667eea; margin-bottom: 10px; text-align: center;">
                        ğŸ¯ æ£€æµ‹ç±»åˆ«ç»Ÿè®¡
                    </div>
                    <div class="object-categories" id="objectCategories">
                        <div class="no-detections" style="text-align: center; color: #666; font-size: 12px; padding: 10px;">
                            æš‚æ— æ£€æµ‹ç»“æœ
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ğŸ“ è‰è“æ£€æµ‹é¢æ¿ -->
        <div class="panel strawberry-panel">
            <div class="panel-header">
                <div class="panel-title">ğŸ“ è‰è“æˆç†Ÿåº¦æ£€æµ‹</div>
                <div class="panel-badge" id="strawberryBadge">å¾…æœº</div>
            </div>

            <div class="strawberry-controls">
                <button class="strawberry-toggle" id="strawberryToggle" onclick="toggleStrawberryDetection()">
                    å¯ç”¨è‰è“æ£€æµ‹
                </button>
                <button class="strawberry-toggle" onclick="requestStrawberryStatus()">
                    åˆ·æ–°çŠ¶æ€
                </button>
                <button class="strawberry-toggle" onclick="debugStrawberryClasses()">
                    ğŸ” è°ƒè¯•ä¿¡æ¯
                </button>
            </div>

            <div class="video-container">
                <img id="strawberryFrame" class="video-frame" style="display: none;" alt="è‰è“æ£€æµ‹ç”»é¢">
                <div id="strawberryPlaceholder" style="color: white; text-align: center;">
                    <div style="font-size: 36px; margin-bottom: 15px;">ğŸ“</div>
                    <div>ç­‰å¾…è‰è“æ£€æµ‹...</div>
                </div>
                <div class="video-overlay" id="strawberryOverlay" style="display: none;">
                    <div id="strawberryFrameInfo">ğŸ“ æ£€æµ‹ä¸­...</div>
                    <div id="strawberryCount">è‰è“: 0 ä¸ª</div>
                </div>
            </div>

            <div class="detection-info">
                <!-- ğŸ“ å½“å‰æ£€æµ‹ç»Ÿè®¡ -->
                <div style="margin-top: 15px;">
                    <div style="font-size: 14px; font-weight: 600; color: #ff6b6b; margin-bottom: 10px; text-align: center;">
                        ğŸ“ å½“å‰æ£€æµ‹æˆç†Ÿåº¦åˆ†å¸ƒ
                    </div>
                    <div class="strawberry-stats">
                        <div class="strawberry-stat-item ripe">
                            <div class="stat-value" id="ripeCount">0</div>
                            <div class="stat-label">ğŸ“ æˆç†Ÿ</div>
                        </div>
                        <div class="strawberry-stat-item nearly-ripe">
                            <div class="stat-value" id="nearlyRipeCount">0</div>
                            <div class="stat-label">ğŸŸ¡ æ¥è¿‘æˆç†Ÿ</div>
                        </div>
                        <div class="strawberry-stat-item unripe">
                            <div class="stat-value" id="unripeCount">0</div>
                            <div class="stat-label">ğŸ”µ æœªæˆç†Ÿ</div>
                        </div>
                        <div class="strawberry-stat-item rotten">
                            <div class="stat-value" id="rottenCount">0</div>
                            <div class="stat-label">ğŸ”´ è…çƒ‚</div>
                        </div>
                        <div class="strawberry-stat-item harvest">
                            <div class="stat-value" id="harvestReady">0</div>
                            <div class="stat-label">ğŸ“¦ å¯æ”¶è·</div>
                        </div>
                        <div class="strawberry-stat-item quality">
                            <div class="stat-value" id="qualityScore">0%</div>
                            <div class="stat-label">âœ¨ è´¨é‡è¯„åˆ†</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI å¯¹è¯é¢æ¿ -->
        <div class="panel ai-panel">
            <div class="panel-header">
                <div class="panel-title">ğŸ§  DeepSeek R1 AI åŠ©æ‰‹</div>
                <div class="panel-badge" id="aiBadge">æœªè¿æ¥</div>
            </div>

            <div class="ai-config">
                <input type="text" id="aiApiUrl" placeholder="APIåœ°å€" value="http://localhost:11434">
                <input type="text" id="aiModelName" placeholder="æ¨¡å‹åç§°" value="deepseek-r1:1.5b">
                <button id="testAiBtn" onclick="testAI()">æµ‹è¯•è¿æ¥</button>
                <button onclick="askGeneralAnalysis()">ğŸ¯ é€šç”¨åˆ†æ</button>
                <button onclick="askStrawberryAdvice()">ğŸ“ è‰è“å»ºè®®</button>
            </div>

            <div class="chat-container">
                <div style="flex: 2;">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message system">
                            <div>ğŸ¤– å¢å¼ºç‰ˆAIåŠ©æ‰‹å·²å‡†å¤‡å°±ç»ªï¼æˆ‘å¯ä»¥å¸®æ‚¨åˆ†æä¼ æ„Ÿå™¨æ•°æ®ã€è§£è¯»æ£€æµ‹ç»“æœã€æä¾›è‰è“ç§æ¤å»ºè®®ç­‰ã€‚</div>
                            <div class="message-time" id="welcomeTime"></div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <textarea id="chatInput" class="chat-input" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜...ä¾‹å¦‚ï¼šåˆ†æå½“å‰è‰è“çŠ¶å†µã€å¦‚ä½•æé«˜è‰è“è´¨é‡ã€ä»€ä¹ˆæ—¶å€™æ”¶è·ï¼Ÿ"></textarea>
                        <button id="chatSend" class="chat-send" onclick="sendAIMessage()">å‘é€</button>
                    </div>
                </div>

                <div class="system-info">
                    <div class="info-section">
                        <div class="info-title">ğŸ”§ ç³»ç»ŸçŠ¶æ€</div>
                        <ul class="info-list" id="systemInfoList">
                            <li>æ­£åœ¨åŠ è½½ç³»ç»Ÿä¿¡æ¯...</li>
                        </ul>
                    </div>

                    <div class="info-section">
                        <div class="info-title">ğŸ“ è‰è“ç»Ÿè®¡</div>
                        <ul class="info-list" id="strawberryInfoList">
                            <li>ç­‰å¾…è‰è“æ£€æµ‹æ•°æ®...</li>
                        </ul>
                    </div>

                    <div class="info-section">
                        <div class="info-title">ğŸ“ˆ æœ€è¿‘æ£€æµ‹</div>
                        <ul class="info-list" id="recentDetectionsList">
                            <li>æš‚æ— æ£€æµ‹ç»“æœ</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let socket;
        let systemStartTime = Date.now();
        let isAIProcessing = false;
        let strawberryEnabled = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const welcomeTime = document.getElementById('welcomeTime');
            welcomeTime.textContent = new Date().toLocaleTimeString();

            // è¿æ¥WebSocket
            initializeSocket();

            // å¯åŠ¨çŠ¶æ€æ›´æ–°
            startStatusUpdates();

            // èŠå¤©è¾“å…¥æ¡†äº‹ä»¶
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAIMessage();
                }
            });

            // åˆå§‹æµ‹è¯•AIè¿æ¥
            setTimeout(testAI, 1000);
        });

        // WebSocketè¿æ¥
        function initializeSocket() {
            try {
                socket = io();

                socket.on('connect', function() {
                    console.log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                    addSystemMessage('âœ… å·²è¿æ¥åˆ°å®Œæ•´ç‰ˆæœåŠ¡å™¨');
                });

                socket.on('disconnect', function() {
                    console.log('âŒ WebSocketè¿æ¥æ–­å¼€');
                    addSystemMessage('âŒ ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
                });

                // ä¼ æ„Ÿå™¨æ•°æ®æ›´æ–°
                socket.on('all_sensors', function(data) {
                    updateSensorDisplay(data);
                });

                socket.on('sensor_update', function(data) {
                    updateSingleSensor(data.sensor_type, data.data);
                });

                // é€šç”¨æ£€æµ‹ç»“æœæ›´æ–°
                socket.on('detection_update', function(data) {
                    updateDetectionDisplay(data);
                });

                // ğŸ“ è‰è“æ£€æµ‹ç»“æœæ›´æ–°
                socket.on('strawberry_update', function(data) {
                    console.log('ğŸ“ æ”¶åˆ°è‰è“æ›´æ–°æ•°æ®:', data);
                    updateStrawberryDisplay(data);
                });

                // è§†é¢‘å¸§æ›´æ–°
                socket.on('video_frame', function(data) {
                    updateVideoFrame(data);
                });

                // ğŸ¯ é€šç”¨æ£€æµ‹æ ‡æ³¨å›¾åƒæ›´æ–°
                socket.on('general_frame', function(data) {
                    updateGeneralFrame(data);
                });

                // ğŸ“ è‰è“æ£€æµ‹æ ‡æ³¨å›¾åƒæ›´æ–°
                socket.on('strawberry_frame', function(data) {
                    console.log('ğŸ“ æ”¶åˆ°è‰è“æ ‡æ³¨å›¾åƒ');
                    updateStrawberryFrame(data);
                });

                // AIå“åº”
                socket.on('ai_response', function(data) {
                    handleAIResponse(data);
                });

                socket.on('ai_processing', function(data) {
                    addAIMessage(data.message, 'user');
                    addLoadingMessage();
                });

                socket.on('ai_status', function(data) {
                    updateAIStatus(data);
                });

                // ç³»ç»ŸçŠ¶æ€æ›´æ–°
                socket.on('status_update', function(data) {
                    updateSystemStatus(data);
                });

                socket.on('mqtt_status', function(data) {
                    updateMQTTStatus(data);
                });

                socket.on('camera_status', function(data) {
                    updateCameraStatus(data);
                });

            } catch (error) {
                console.error('âŒ WebSocketåˆå§‹åŒ–å¤±è´¥:', error);
                addSystemMessage('âŒ WebSocketåˆå§‹åŒ–å¤±è´¥');
            }
        }

        // ğŸ“ è‰è“æ£€æµ‹ç›¸å…³å‡½æ•° - ä¿®å¤ç‰ˆ
        async function toggleStrawberryDetection() {
            const btn = document.getElementById('strawberryToggle');
            btn.disabled = true;
            btn.textContent = 'åˆ‡æ¢ä¸­...';

            try {
                const response = await fetch('/api/strawberry/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    strawberryEnabled = result.enabled;
                    btn.textContent = strawberryEnabled ? 'ç¦ç”¨è‰è“æ£€æµ‹' : 'å¯ç”¨è‰è“æ£€æµ‹';

                    updateStrawberryStatus();
                    addSystemMessage(`ğŸ“ ${result.message}`);
                } else {
                    addSystemMessage(`âŒ è‰è“æ£€æµ‹åˆ‡æ¢å¤±è´¥: ${result.error}`);
                }
            } catch (error) {
                addSystemMessage(`âŒ è‰è“æ£€æµ‹åˆ‡æ¢å¤±è´¥: ${error.message}`);
                console.error('âŒ è‰è“æ£€æµ‹åˆ‡æ¢é”™è¯¯:', error);
            }

            btn.disabled = false;
        }

        async function requestStrawberryStatus() {
            try {
                const response = await fetch('/api/strawberry/status');
                const status = await response.json();

                strawberryEnabled = status.enabled;

                updateStrawberryStatus();

                const statusMsg = `ğŸ“ è‰è“æ£€æµ‹çŠ¶æ€: ${status.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}ï¼Œ` +
                                 `æ¨¡å‹: ${status.model_loaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}`;

                addSystemMessage(statusMsg);

                console.log('ğŸ“ è‰è“æ£€æµ‹çŠ¶æ€:', status);

            } catch (error) {
                addSystemMessage(`âŒ è·å–è‰è“çŠ¶æ€å¤±è´¥: ${error.message}`);
                console.error('âŒ è·å–è‰è“çŠ¶æ€é”™è¯¯:', error);
            }
        }

        function updateStrawberryStatus() {
            const statusDot = document.getElementById('strawberryStatus');
            const statusText = document.getElementById('strawberryText');
            const badge = document.getElementById('strawberryBadge');
            const toggle = document.getElementById('strawberryToggle');

            if (strawberryEnabled) {
                statusDot.classList.add('connected');
                statusText.textContent = 'å·²å¯ç”¨';
                badge.textContent = 'å·²å¯ç”¨';
                badge.style.background = '#28a745';
                toggle.textContent = 'ç¦ç”¨è‰è“æ£€æµ‹';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'å·²ç¦ç”¨';
                badge.textContent = 'å·²ç¦ç”¨';
                badge.style.background = '#dc3545';
                toggle.textContent = 'å¯ç”¨è‰è“æ£€æµ‹';
            }
        }

        function updateStrawberryDisplay(data) {
            console.log('ğŸ“ æ›´æ–°è‰è“æ˜¾ç¤ºæ•°æ®:', data);

            // è·å–ç»Ÿè®¡æ•°æ®
            const stats = data.stats || {};
            const currentRipeness = stats.current_ripeness || {};
            const totalRipeness = stats.ripeness_counts || {};

            // æ›´æ–°å½“å‰å¸§çš„è‰è“æˆç†Ÿåº¦åˆ†å¸ƒ
            document.getElementById('ripeCount').textContent = currentRipeness['Ripe'] || 0;
            document.getElementById('nearlyRipeCount').textContent = currentRipeness['Nearly Ripe'] || 0;
            document.getElementById('unripeCount').textContent = currentRipeness['Unripe'] || 0;
            document.getElementById('rottenCount').textContent = currentRipeness['Rotten'] || 0;

            // æ›´æ–°è´¨é‡æŒ‡æ ‡
            document.getElementById('harvestReady').textContent = stats.current_harvest_ready || 0;
            document.getElementById('qualityScore').textContent = `${stats.current_quality_score || 0}%`;

            // æ›´æ–°badge
            const badge = document.getElementById('strawberryBadge');
            if (data.detection_count > 0) {
                badge.textContent = `ğŸ“ ${data.detection_count} ä¸ªè‰è“`;
                badge.style.background = '#ff6b6b';
            } else {
                badge.textContent = strawberryEnabled ? 'æœªæ£€æµ‹åˆ°è‰è“' : 'å·²ç¦ç”¨';
                badge.style.background = strawberryEnabled ? '#6c757d' : '#dc3545';
            }

            // æ›´æ–°å³ä¾§ä¿¡æ¯æ çš„è‰è“ç»Ÿè®¡
            updateStrawberryInfo(stats, currentRipeness, totalRipeness);

            console.log('ğŸ“ è‰è“æ£€æµ‹æ•°æ®æ›´æ–°å®Œæˆ');
        }

        function updateStrawberryInfo(stats, currentRipeness, totalRipeness) {
            const list = document.getElementById('strawberryInfoList');

            if (!list) {
                console.warn('âš ï¸ æœªæ‰¾åˆ°è‰è“ä¿¡æ¯åˆ—è¡¨å…ƒç´ ');
                return;
            }

            // è®¡ç®—æ€»æ•°
            const currentTotal = Object.values(currentRipeness).reduce((sum, count) => sum + count, 0);
            const totalCount = Object.values(totalRipeness).reduce((sum, count) => sum + count, 0);

            // åˆ›å»ºä¿¡æ¯åˆ—è¡¨
            const infoItems = [
                `ğŸ“ å½“å‰æ£€æµ‹: ${currentTotal} ä¸ªè‰è“`,
                `ğŸŸ¢ å½“å‰æˆç†Ÿ: ${currentRipeness['Ripe'] || 0} ä¸ª`,
                `ğŸŸ¡ æ¥è¿‘æˆç†Ÿ: ${currentRipeness['Nearly Ripe'] || 0} ä¸ª`,
                `ğŸ”µ æœªæˆç†Ÿ: ${currentRipeness['Unripe'] || 0} ä¸ª`,
                `ğŸ”´ è…çƒ‚: ${currentRipeness['Rotten'] || 0} ä¸ª`,
                `âœ¨ å½“å‰è´¨é‡: ${stats.current_quality_score || 0}%`,
                `ğŸ“¦ å¯æ”¶è·: ${stats.current_harvest_ready || 0} ä¸ª`,
                `ğŸ“Š å†å²æ€»æ•°: ${totalCount} ä¸ª`,
                `â±ï¸ å¤„ç†æ—¶é—´: ${(stats.processing_time || 0).toFixed(2)}s`
            ];

            list.innerHTML = infoItems.map(item => `<li>${item}</li>`).join('');
        }

        async function debugStrawberryClasses() {
            try {
                const response = await fetch('/api/strawberry/debug');
                const debugInfo = await response.json();

                console.log('ğŸ“ è‰è“æ£€æµ‹è°ƒè¯•ä¿¡æ¯:', debugInfo);

                let debugMessage = `ğŸ“ è‰è“æ£€æµ‹è°ƒè¯•ä¿¡æ¯ï¼š\n\n`;

                // é…ç½®ä¿¡æ¯
                debugMessage += `ğŸ”§ é…ç½®ä¿¡æ¯ï¼š\n`;
                debugMessage += `- æ£€æµ‹çŠ¶æ€: ${debugInfo.enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}\n`;
                debugMessage += `- æ¨¡å‹åŠ è½½: ${debugInfo.model_loaded ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}\n`;
                debugMessage += `- æ¨¡å‹è·¯å¾„: ${debugInfo.model_path}\n`;
                debugMessage += `- é…ç½®æ–‡ä»¶: ${debugInfo.yaml_path}\n`;
                debugMessage += `- YAMLå­˜åœ¨: ${debugInfo.yaml_exists ? 'æ˜¯' : 'å¦'}\n\n`;

                // ç±»åˆ«é…ç½®
                debugMessage += `ğŸ“ æ£€æµ‹ç±»åˆ« (${debugInfo.class_count}ä¸ª)ï¼š\n`;
                debugInfo.classes.forEach((className, index) => {
                    debugMessage += `- ID ${index}: ${className}\n`;
                });

                // å½“å‰æ£€æµ‹åˆ†å¸ƒ
                debugMessage += `\nğŸ“Š å½“å‰å¸§æ£€æµ‹åˆ†å¸ƒï¼š\n`;
                for (const [className, count] of Object.entries(debugInfo.current_ripeness || {})) {
                    debugMessage += `- ${className}: ${count}ä¸ª\n`;
                }

                // å†å²ç´¯è®¡ç»Ÿè®¡
                debugMessage += `\nğŸ“ˆ å†å²ç´¯è®¡ç»Ÿè®¡ï¼š\n`;
                for (const [className, count] of Object.entries(debugInfo.total_ripeness || {})) {
                    debugMessage += `- ${className}: ${count}ä¸ª\n`;
                }

                // æ€§èƒ½ä¿¡æ¯
                debugMessage += `\nâ±ï¸ æ€§èƒ½ä¿¡æ¯ï¼š\n`;
                debugMessage += `- å¤„ç†æ—¶é—´: ${(debugInfo.processing_time || 0).toFixed(2)}s\n`;
                debugMessage += `- æ€»æ£€æµ‹æ•°: ${debugInfo.total_detections || 0}\n`;

                // æœ€è¿‘æ£€æµ‹è®°å½•
                if (debugInfo.last_detections && debugInfo.last_detections.length > 0) {
                    debugMessage += `\nğŸ” æœ€è¿‘æ£€æµ‹è®°å½•ï¼š\n`;
                    debugInfo.last_detections.forEach((detection, index) => {
                        debugMessage += `${index + 1}. ${detection.class_name} (ç½®ä¿¡åº¦: ${(detection.confidence * 100).toFixed(1)}%)\n`;
                    });
                } else {
                    debugMessage += `\nğŸ” æœ€è¿‘æ£€æµ‹è®°å½•ï¼šæš‚æ— \n`;
                }

                alert(debugMessage);
                addSystemMessage('ğŸ” è‰è“è°ƒè¯•ä¿¡æ¯å·²æ˜¾ç¤º');

            } catch (error) {
                console.error('âŒ è·å–è°ƒè¯•ä¿¡æ¯å¤±è´¥:', error);
                addSystemMessage(`âŒ è·å–è°ƒè¯•ä¿¡æ¯å¤±è´¥: ${error.message}`);
            }
        }

        function updateStrawberryFrame(data) {
            const strawberryFrame = document.getElementById('strawberryFrame');
            const strawberryPlaceholder = document.getElementById('strawberryPlaceholder');
            const strawberryOverlay = document.getElementById('strawberryOverlay');
            const strawberryFrameInfo = document.getElementById('strawberryFrameInfo');
            const strawberryCount = document.getElementById('strawberryCount');

            if (data.frame) {
                try {
                    strawberryFrame.src = 'data:image/jpeg;base64,' + data.frame;
                    strawberryFrame.style.display = 'block';
                    strawberryPlaceholder.style.display = 'none';
                    strawberryOverlay.style.display = 'block';

                    strawberryFrameInfo.textContent = `ğŸ“ è‰è“æ ‡æ³¨: ${data.image_filename || 'unknown'}`;
                    strawberryCount.textContent = `è‰è“: ${data.strawberry_count || 0} ä¸ª`;

                    console.log('ğŸ“ è‰è“æ£€æµ‹æ ‡æ³¨å›¾åƒå·²æ›´æ–°');
                } catch (error) {
                    console.error('ğŸ“ è‰è“å›¾åƒæ›´æ–°å¤±è´¥:', error);
                }
            }
        }

        // AIåŠ©æ‰‹å¢å¼ºç‰ˆåˆ†æå‡½æ•° - å¸¦æ•°æ®ç¼ºå¤±æ£€æµ‹
        async function askGeneralAnalysis() {
            let detectionData = null;
            let sensorsData = null;
            let missingData = [];
            let contextInfo = "è¯·åŸºäºä»¥ä¸‹æ•°æ®æä¾›é€šç”¨æ£€æµ‹å®‰å…¨æ€§å’Œç›‘æ§åˆ†æï¼š\n\n";

            // å°è¯•è·å–æ£€æµ‹æ•°æ®
            try {
                const detectionResponse = await fetch('/api/detections');
                if (detectionResponse.ok) {
                    const responseData = await detectionResponse.json();
                    // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
                    if (responseData.error) {
                        missingData.push(`é€šç”¨æ£€æµ‹æ•°æ® (${responseData.error})`);
                        console.warn('âš ï¸ é€šç”¨æ£€æµ‹æ•°æ®æœ‰é”™è¯¯:', responseData.error);
                    } else {
                        detectionData = responseData;
                        console.log('âœ… æˆåŠŸè·å–é€šç”¨æ£€æµ‹æ•°æ®');
                    }
                } else {
                    missingData.push('é€šç”¨æ£€æµ‹æ•°æ®');
                    console.warn('âš ï¸ é€šç”¨æ£€æµ‹æ•°æ®è·å–å¤±è´¥');
                }
            } catch (error) {
                missingData.push('é€šç”¨æ£€æµ‹æ•°æ®');
                console.error('âŒ é€šç”¨æ£€æµ‹æ•°æ®è¯·æ±‚å¼‚å¸¸:', error);
            }

            // å°è¯•è·å–ä¼ æ„Ÿå™¨æ•°æ®
            try {
                const sensorsResponse = await fetch('/api/sensors');
                if (sensorsResponse.ok) {
                    const responseData = await sensorsResponse.json();
                    // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æˆ–è­¦å‘Šä¿¡æ¯
                    if (responseData.error) {
                        missingData.push(`ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ® (${responseData.error})`);
                        console.warn('âš ï¸ ä¼ æ„Ÿå™¨æ•°æ®æœ‰é”™è¯¯:', responseData.error);
                    } else if (responseData.warning) {
                        missingData.push(`ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ® (${responseData.warning})`);
                        console.warn('âš ï¸ ä¼ æ„Ÿå™¨æ•°æ®è­¦å‘Š:', responseData.warning);
                    } else {
                        sensorsData = responseData;
                        console.log('âœ… æˆåŠŸè·å–ä¼ æ„Ÿå™¨æ•°æ®');
                    }
                } else {
                    missingData.push('ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ®');
                    console.warn('âš ï¸ ä¼ æ„Ÿå™¨æ•°æ®è·å–å¤±è´¥');
                }
            } catch (error) {
                missingData.push('ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ®');
                console.error('âŒ ä¼ æ„Ÿå™¨æ•°æ®è¯·æ±‚å¼‚å¸¸:', error);
            }

            // å¤„ç†æ•°æ®ç¼ºå¤±æƒ…å†µ
            if (missingData.length > 0) {
                contextInfo += `âš ï¸ æ•°æ®ç¼ºå¤±è­¦å‘Šï¼š\n`;
                missingData.forEach(dataType => {
                    contextInfo += `- ç¼ºå¤±ï¼š${dataType}\n`;
                });
                contextInfo += `\nè¯·åŸºäºå¯ç”¨æ•°æ®è¿›è¡Œåˆ†æï¼Œå¹¶è¯´æ˜æ•°æ®ç¼ºå¤±å¯¹åˆ†æç»“æœçš„å½±å“ã€‚\n\n`;
            }

            // === é€šç”¨æ£€æµ‹æ•°æ®åˆ†æ ===
            if (detectionData) {
                contextInfo += "ğŸ¯ é€šç”¨ç‰©ä½“æ£€æµ‹æ•°æ®ï¼š\n";
                if (detectionData.detection_count > 0) {
                    contextInfo += `ğŸ“Š æ£€æµ‹æ¦‚å†µï¼š\n`;
                    contextInfo += `- æ€»æ£€æµ‹ç‰©ä½“æ•°: ${detectionData.detection_count}ä¸ª\n`;
                    contextInfo += `- å¤„ç†æ—¶é—´: ${(detectionData.detection_stats?.processing_time || 0).toFixed(2)}ç§’\n`;
                    contextInfo += `- å†å²æ€»æ£€æµ‹æ•°: ${detectionData.detection_stats?.total_detections || 0}ä¸ª\n\n`;

                    // å½“å‰æ£€æµ‹åˆ°çš„ç‰©ä½“ç±»åˆ«å’Œæ•°é‡
                    if (detectionData.current_objects && Object.keys(detectionData.current_objects).length > 0) {
                        contextInfo += `ğŸ¯ å½“å‰æ£€æµ‹åˆ°çš„ç‰©ä½“ç±»åˆ«å’Œæ•°é‡ï¼š\n`;
                        for (const [className, count] of Object.entries(detectionData.current_objects)) {
                            contextInfo += `- ${className}: ${count}ä¸ª\n`;
                        }
                        contextInfo += `\n`;
                    }

                    // å†å²ç´¯è®¡æ£€æµ‹ç»Ÿè®¡
                    if (detectionData.category_distribution && Object.keys(detectionData.category_distribution).length > 0) {
                        contextInfo += `ğŸ“ˆ å†å²æ£€æµ‹ç±»åˆ«åˆ†å¸ƒæ¯”ä¾‹ï¼š\n`;
                        for (const [className, percentage] of Object.entries(detectionData.category_distribution)) {
                            contextInfo += `- ${className}: ${percentage}%\n`;
                        }
                        contextInfo += `\n`;
                    }

                    // æ£€æµ‹æ€»ç»“
                    if (detectionData.summary) {
                        contextInfo += `ğŸ“‹ æ£€æµ‹æ€»ç»“: ${detectionData.summary}\n\n`;
                    }
                } else {
                    contextInfo += "âŒ å½“å‰æœªæ£€æµ‹åˆ°ä»»ä½•ç‰©ä½“\n\n";
                }
            } else {
                contextInfo += "âŒ é€šç”¨æ£€æµ‹æ•°æ®ä¸å¯ç”¨\n\n";
            }

            // === ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ®åˆ†æ ===
            if (sensorsData) {
                contextInfo += "ğŸŒ¡ï¸ ç¯å¢ƒç›‘æµ‹æ•°æ®ï¼š\n";
                const sensors = sensorsData.sensor_data || {};

                // æ¸©åº¦æ•°æ®
                if (sensors.temperature && sensors.temperature.value !== null) {
                    contextInfo += `- æ¸©åº¦: ${sensors.temperature.value}Â°C (çŠ¶æ€: ${getStatusText(sensors.temperature.status)})\n`;
                } else {
                    contextInfo += `- æ¸©åº¦: æ— æ•°æ®\n`;
                }

                // æ¹¿åº¦æ•°æ®
                if (sensors.humidity && sensors.humidity.value !== null) {
                    contextInfo += `- æ¹¿åº¦: ${sensors.humidity.value}% (çŠ¶æ€: ${getStatusText(sensors.humidity.status)})\n`;
                } else {
                    contextInfo += `- æ¹¿åº¦: æ— æ•°æ®\n`;
                }

                // å…‰ç…§æ•°æ®
                if (sensors.light && sensors.light.value !== null) {
                    contextInfo += `- å…‰ç…§: ${sensors.light.value}lux (çŠ¶æ€: ${getStatusText(sensors.light.status)})\n`;
                } else {
                    contextInfo += `- å…‰ç…§: æ— æ•°æ®\n`;
                }
                contextInfo += `\n`;
            } else {
                contextInfo += "âŒ ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ®ä¸å¯ç”¨\n\n";
            }

            // === åˆ†æè¦æ±‚ ===
            contextInfo += "ğŸ” è¯·è¿›è¡Œç»¼åˆåˆ†æå¹¶æä¾›å»ºè®®ï¼š\n\n";

            if (detectionData) {
                contextInfo += "ğŸ¯ æ£€æµ‹ç»“æœåˆ†æï¼š\n";
                contextInfo += "1. ç¯å¢ƒå®‰å…¨æ€§è¯„ä¼°ï¼ˆæ˜¯å¦æœ‰å¼‚å¸¸ç‰©ä½“ï¼‰\n";
                contextInfo += "2. ç›‘æ§åŒºåŸŸçŠ¶å†µåˆ†æ\n";
                contextInfo += "3. æ½œåœ¨é£é™©è¯†åˆ«\n";
                contextInfo += "4. å¦‚æœæ£€æµ‹åˆ°äººå‘˜ï¼Œåˆ†ææ´»åŠ¨æ¨¡å¼\n";
                contextInfo += "5. è®¾å¤‡æˆ–å·¥å…·çš„ä½¿ç”¨æƒ…å†µåˆ†æ\n\n";
            }

            if (sensorsData) {
                contextInfo += "ğŸŒ¡ï¸ ç¯å¢ƒæ¡ä»¶åˆ†æï¼š\n";
                contextInfo += "1. è¯„ä¼°å½“å‰ç¯å¢ƒå‚æ•°æ˜¯å¦æ­£å¸¸\n";
                contextInfo += "2. åˆ†æç¯å¢ƒå¯¹ç›‘æ§æ•ˆæœçš„å½±å“\n";
                contextInfo += "3. æä¾›ç¯å¢ƒä¼˜åŒ–å»ºè®®\n\n";
            }

            contextInfo += "ğŸ’¡ ç»¼åˆå»ºè®®ï¼š\n";
            contextInfo += "1. ç›‘æ§ç³»ç»Ÿä¼˜åŒ–å»ºè®®\n";
            contextInfo += "2. å®‰å…¨é˜²æŠ¤æªæ–½\n";
            contextInfo += "3. å¼‚å¸¸æƒ…å†µå¤„ç†æ–¹æ¡ˆ";

            if (missingData.length > 0) {
                contextInfo += `\n\nâš ï¸ æ³¨æ„ï¼šç”±äºç¼ºå¤±${missingData.join('ã€')}ï¼Œè¯·åœ¨åˆ†æä¸­è¯´æ˜è¿™äº›æ•°æ®ç¼ºå¤±å¯¹ç»“è®ºçš„å½±å“ã€‚`;
            }

            document.getElementById('chatInput').value = contextInfo;
            sendAIMessage();
        }

        // AIåŠ©æ‰‹è¯¢é—®è‰è“å»ºè®®å‡½æ•° - å¢å¼ºç‰ˆï¼ˆå¸¦æ•°æ®ç¼ºå¤±æ£€æµ‹ï¼‰
        async function askStrawberryAdvice() {
            let strawberryData = null;
            let sensorsData = null;
            let missingData = [];
            let contextInfo = "è¯·åŸºäºä»¥ä¸‹æ•°æ®æä¾›ä¸“ä¸šçš„è‰è“ç§æ¤åˆ†æå’Œå»ºè®®ï¼š\n\n";

            // å°è¯•è·å–è‰è“æ£€æµ‹æ•°æ®
            try {
                const strawberryResponse = await fetch('/api/strawberry/detections');
                if (strawberryResponse.ok) {
                    const responseData = await strawberryResponse.json();
                    // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
                    if (responseData.error) {
                        missingData.push(`è‰è“æ£€æµ‹æ•°æ® (${responseData.error})`);
                        console.warn('âš ï¸ è‰è“æ£€æµ‹æ•°æ®æœ‰é”™è¯¯:', responseData.error);
                    } else {
                        strawberryData = responseData;
                        console.log('âœ… æˆåŠŸè·å–è‰è“æ£€æµ‹æ•°æ®');
                    }
                } else {
                    missingData.push('è‰è“æ£€æµ‹æ•°æ®');
                    console.warn('âš ï¸ è‰è“æ£€æµ‹æ•°æ®è·å–å¤±è´¥');
                }
            } catch (error) {
                missingData.push('è‰è“æ£€æµ‹æ•°æ®');
                console.error('âŒ è‰è“æ£€æµ‹æ•°æ®è¯·æ±‚å¼‚å¸¸:', error);
            }

            // å°è¯•è·å–ä¼ æ„Ÿå™¨æ•°æ®
            try {
                const sensorsResponse = await fetch('/api/sensors');
                if (sensorsResponse.ok) {
                    const responseData = await sensorsResponse.json();
                    // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯æˆ–è­¦å‘Šä¿¡æ¯
                    if (responseData.error) {
                        missingData.push(`ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ® (${responseData.error})`);
                        console.warn('âš ï¸ ä¼ æ„Ÿå™¨æ•°æ®æœ‰é”™è¯¯:', responseData.error);
                    } else if (responseData.warning) {
                        missingData.push(`ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ® (${responseData.warning})`);
                        console.warn('âš ï¸ ä¼ æ„Ÿå™¨æ•°æ®è­¦å‘Š:', responseData.warning);
                    } else {
                        sensorsData = responseData;
                        console.log('âœ… æˆåŠŸè·å–ä¼ æ„Ÿå™¨æ•°æ®');
                    }
                } else {
                    missingData.push('ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ®');
                    console.warn('âš ï¸ ä¼ æ„Ÿå™¨æ•°æ®è·å–å¤±è´¥');
                }
            } catch (error) {
                missingData.push('ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ®');
                console.error('âŒ ä¼ æ„Ÿå™¨æ•°æ®è¯·æ±‚å¼‚å¸¸:', error);
            }

            // å¤„ç†æ•°æ®ç¼ºå¤±æƒ…å†µ
            if (missingData.length > 0) {
                contextInfo += `âš ï¸ æ•°æ®ç¼ºå¤±è­¦å‘Šï¼š\n`;
                missingData.forEach(dataType => {
                    contextInfo += `- ç¼ºå¤±ï¼š${dataType}\n`;
                });
                contextInfo += `\nè¯·åŸºäºå¯ç”¨æ•°æ®è¿›è¡Œåˆ†æï¼Œå¹¶è¯´æ˜æ•°æ®ç¼ºå¤±å¯¹ç§æ¤å»ºè®®çš„å½±å“ã€‚\n\n`;
            }

            // === è‰è“æ£€æµ‹æ•°æ®åˆ†æ ===
            if (strawberryData) {
                contextInfo += "ğŸ“ è‰è“æ£€æµ‹çŠ¶å†µï¼š\n";
                if (strawberryData.detection_count > 0) {
                    contextInfo += `- å½“å‰æ£€æµ‹åˆ°: ${strawberryData.detection_count}ä¸ªè‰è“\n`;

                    // è¯¦ç»†æˆç†Ÿåº¦åˆ†å¸ƒ
                    if (strawberryData.detection_stats?.current_ripeness) {
                        contextInfo += "- æˆç†Ÿåº¦åˆ†å¸ƒï¼š\n";
                        const ripeness = strawberryData.detection_stats.current_ripeness;
                        if (ripeness['Ripe'] > 0) contextInfo += `  * æˆç†Ÿ(Ripe): ${ripeness['Ripe']}ä¸ª\n`;
                        if (ripeness['Nearly Ripe'] > 0) contextInfo += `  * æ¥è¿‘æˆç†Ÿ(Nearly Ripe): ${ripeness['Nearly Ripe']}ä¸ª\n`;
                        if (ripeness['Unripe'] > 0) contextInfo += `  * æœªæˆç†Ÿ(Unripe): ${ripeness['Unripe']}ä¸ª\n`;
                        if (ripeness['Rotten'] > 0) contextInfo += `  * è…çƒ‚(Rotten): ${ripeness['Rotten']}ä¸ª\n`;
                    }

                    // è´¨é‡æŒ‡æ ‡
                    contextInfo += `- å½“å‰è´¨é‡è¯„åˆ†: ${strawberryData.detection_stats?.current_quality_score || 0}%\n`;
                    contextInfo += `- å¯æ”¶è·æ•°é‡: ${strawberryData.detection_stats?.current_harvest_ready || 0}ä¸ª\n`;

                    // å†å²ç»Ÿè®¡
                    if (strawberryData.detection_stats?.total_detections) {
                        contextInfo += `- å†å²æ€»æ£€æµ‹æ•°: ${strawberryData.detection_stats.total_detections}ä¸ª\n`;
                    }
                } else {
                    contextInfo += "- âŒ å½“å‰æœªæ£€æµ‹åˆ°è‰è“\n";
                }
                contextInfo += `\n`;
            } else {
                contextInfo += "âŒ è‰è“æ£€æµ‹æ•°æ®ä¸å¯ç”¨\n\n";
            }

            // === ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ®åˆ†æ ===
            if (sensorsData) {
                contextInfo += "ğŸŒ¡ï¸ ç¯å¢ƒç›‘æµ‹æ•°æ®ï¼š\n";
                const sensors = sensorsData.sensor_data || {};

                // æ¸©åº¦æ•°æ®
                if (sensors.temperature && sensors.temperature.value !== null) {
                    contextInfo += `- æ¸©åº¦: ${sensors.temperature.value}Â°C (çŠ¶æ€: ${getStatusText(sensors.temperature.status)})\n`;
                } else {
                    contextInfo += `- æ¸©åº¦: æ— æ•°æ®\n`;
                }

                // æ¹¿åº¦æ•°æ®
                if (sensors.humidity && sensors.humidity.value !== null) {
                    contextInfo += `- æ¹¿åº¦: ${sensors.humidity.value}% (çŠ¶æ€: ${getStatusText(sensors.humidity.status)})\n`;
                } else {
                    contextInfo += `- æ¹¿åº¦: æ— æ•°æ®\n`;
                }

                // å…‰ç…§æ•°æ®
                if (sensors.light && sensors.light.value !== null) {
                    contextInfo += `- å…‰ç…§: ${sensors.light.value}lux (çŠ¶æ€: ${getStatusText(sensors.light.status)})\n`;
                } else {
                    contextInfo += `- å…‰ç…§: æ— æ•°æ®\n`;
                }
                contextInfo += `\n`;
            } else {
                contextInfo += "âŒ ç¯å¢ƒä¼ æ„Ÿå™¨æ•°æ®ä¸å¯ç”¨\n\n";
            }

            // === åˆ†æè¦æ±‚ ===
            contextInfo += "ğŸ” è¯·è¿›è¡Œç»¼åˆåˆ†æå¹¶æä¾›å»ºè®®ï¼š\n\n";

            if (strawberryData) {
                contextInfo += "ğŸ“‹ è‰è“çŠ¶å†µåˆ†æï¼š\n";
                contextInfo += "1. æ ¹æ®æˆç†Ÿåº¦åˆ†å¸ƒè¯„ä¼°å½“å‰è‰è“å‘è‚²çŠ¶å†µ\n";
                contextInfo += "2. åˆ†æè´¨é‡è¯„åˆ†ï¼Œè¯†åˆ«æ½œåœ¨é—®é¢˜\n";
                contextInfo += "3. åˆ¤æ–­æœ€ä½³æ”¶è·æ—¶æœºå’Œæ”¶è·ç­–ç•¥\n";
                contextInfo += "4. å¦‚å‘ç°è…çƒ‚è‰è“ï¼Œæä¾›å¤„ç†å»ºè®®\n\n";
            }

            if (sensorsData) {
                contextInfo += "ğŸŒ± ç¯å¢ƒæ¡ä»¶åˆ†æï¼š\n";
                contextInfo += "1. è¯„ä¼°å½“å‰æ¸©åº¦æ˜¯å¦é€‚å®œè‰è“ç”Ÿé•¿ï¼ˆæœ€é€‚18-25Â°Cï¼‰\n";
                contextInfo += "2. åˆ†ææ¹¿åº¦æ°´å¹³æ˜¯å¦åˆç†ï¼ˆæœ€é€‚60-80%ï¼‰\n";
                contextInfo += "3. åˆ¤æ–­å…‰ç…§å¼ºåº¦æ˜¯å¦å……è¶³ï¼ˆæœ€é€‚15000-35000luxï¼‰\n";
                contextInfo += "4. è¯†åˆ«ç¯å¢ƒå‚æ•°ä¸­çš„å¼‚å¸¸æˆ–é£é™©å› å­\n\n";
            }

            contextInfo += "ğŸ’¡ ç§æ¤ç®¡ç†å»ºè®®ï¼š\n";

            if (sensorsData) {
                contextInfo += "1. åŸºäºç¯å¢ƒæ•°æ®æä¾›æµ‡æ°´ã€é€šé£ã€å…‰ç…§è°ƒèŠ‚å»ºè®®\n";
                contextInfo += "2. æ ¹æ®è‰è“å‘è‚²é˜¶æ®µç»™å‡ºæ–½è‚¥å»ºè®®\n";
                contextInfo += "3. æä¾›ç—…è™«å®³é¢„é˜²æªæ–½\n";
            } else {
                contextInfo += "1. æä¾›é€šç”¨çš„è‰è“ç§æ¤ç®¡ç†å»ºè®®\n";
                contextInfo += "2. åŸºäºè‰è“çŠ¶å†µç»™å‡ºæŠ¤ç†å»ºè®®\n";
            }

            contextInfo += "4. ç»™å‡ºæœªæ¥3-7å¤©çš„ç®¡ç†è®¡åˆ’\n";
            contextInfo += "5. å¦‚æœ‰å¼‚å¸¸æŒ‡æ ‡ï¼Œæä¾›ç´§æ€¥å¤„ç†æ–¹æ¡ˆ";

            if (missingData.length > 0) {
                contextInfo += `\n\nâš ï¸ æ³¨æ„ï¼šç”±äºç¼ºå¤±${missingData.join('ã€')}ï¼Œè¯·åœ¨å»ºè®®ä¸­è¯´æ˜è¿™äº›æ•°æ®ç¼ºå¤±å¯¹ç§æ¤ç®¡ç†å»ºè®®çš„å½±å“ï¼Œå¹¶æä¾›ç›¸åº”çš„æ›¿ä»£æ–¹æ¡ˆã€‚`;
            }

            document.getElementById('chatInput').value = contextInfo;
            sendAIMessage();
        }

        // AIç›¸å…³å‡½æ•°
        async function testAI() {
            const btn = document.getElementById('testAiBtn');
            const apiUrl = document.getElementById('aiApiUrl').value;
            const modelName = document.getElementById('aiModelName').value;

            btn.disabled = true;
            btn.textContent = 'æµ‹è¯•ä¸­...';

            try {
                const response = await fetch('/api/ai/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_url: apiUrl,
                        model_name: modelName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    addSystemMessage(`âœ… AIè¿æ¥æˆåŠŸï¼æ¨¡å‹: ${result.model_name}`);
                    updateAIStatus({
                        enabled: true,
                        status: 'connected'
                    });
                } else {
                    addSystemMessage(`âŒ AIè¿æ¥å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
                    updateAIStatus({
                        enabled: false,
                        status: result.status || 'error'
                    });
                }
            } catch (error) {
                console.error('âŒ AIæµ‹è¯•å¤±è´¥:', error);
                addSystemMessage(`âŒ AIæµ‹è¯•å¤±è´¥: ${error.message}`);
                updateAIStatus({
                    enabled: false,
                    status: 'error'
                });
            }

            btn.disabled = false;
            btn.textContent = 'æµ‹è¯•è¿æ¥';
        }

        function sendAIMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSend');
            const message = input.value.trim();

            if (!message || isAIProcessing) return;

            isAIProcessing = true;
            sendBtn.disabled = true;
            sendBtn.textContent = 'å‘é€ä¸­...';

            // é€šè¿‡WebSocketå‘é€æ¶ˆæ¯
            socket.emit('ai_message', {
                message: message,
                context: null
            });

            input.value = '';
        }

        function handleAIResponse(data) {
            removeLoadingMessage();

            if (data.error) {
                addAIMessage(`âŒ é”™è¯¯: ${data.error}`, 'ai');
            } else if (data.response) {
                addAIMessage(data.response, 'ai');
            }

            isAIProcessing = false;
            const sendBtn = document.getElementById('chatSend');
            sendBtn.disabled = false;
            sendBtn.textContent = 'å‘é€';
        }

        function addAIMessage(content, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const time = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `
                <div style="white-space: pre-wrap;">${content}</div>
                <div class="message-time">${time}</div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';

            const time = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `
                <div>${content}</div>
                <div class="message-time">${time}</div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addLoadingMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message ai loading-message';
            loadingDiv.id = 'loadingMessage';
            loadingDiv.innerHTML = `
                <div class="loading">
                    <span>AIæ­£åœ¨æ€è€ƒ</span>
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;

            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        // å…¶ä»–æ›´æ–°å‡½æ•°ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        function startStatusUpdates() {
            setInterval(function() {
                updateUptime();
                requestSystemInfo();
            }, 1000);
        }

        function updateUptime() {
            const uptime = Math.floor((Date.now() - systemStartTime) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;

            document.getElementById('uptime').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateSensorDisplay(sensors) {
            for (const [sensorType, data] of Object.entries(sensors)) {
                updateSingleSensor(sensorType, data);
            }
        }

        function updateSingleSensor(sensorType, data) {
            const valueElement = document.getElementById(`${sensorType}Value`);
            const statusElement = document.getElementById(`${sensorType}Status`);
            const cardElement = document.getElementById(`${sensorType}Card`);

            if (valueElement && statusElement && cardElement) {
                if (data.value !== null) {
                    valueElement.textContent = `${data.value}${data.unit}`;
                    statusElement.textContent = getStatusText(data.status);
                    cardElement.className = `sensor-card ${data.status}`;
                } else {
                    valueElement.textContent = '--';
                    statusElement.textContent = 'ç­‰å¾…æ•°æ®';
                    cardElement.className = 'sensor-card';
                }
            }
        }

        function getStatusText(status) {
            const statusTexts = {
                'optimal': 'ç†æƒ³',
                'good': 'è‰¯å¥½',
                'low': 'åä½',
                'high': 'åé«˜',
                'warning': 'è­¦å‘Š',
                'waiting': 'ç­‰å¾…'
            };
            return statusTexts[status] || 'æœªçŸ¥';
        }

        function updateDetectionDisplay(data) {
            document.getElementById('totalDetections').textContent = data.stats?.total_detections || 0;
            document.getElementById('currentDetections').textContent = data.detection_count || 0;
            document.getElementById('processingTime').textContent = `${(data.stats?.processing_time || 0).toFixed(2)}s`;
            document.getElementById('currentImage').textContent = data.image_filename || '--';

            const badge = document.getElementById('detectionBadge');
            if (data.detection_count > 0) {
                badge.textContent = `æ£€æµ‹åˆ° ${data.detection_count} ä¸ªç‰©ä½“`;
                badge.style.background = '#28a745';
            } else {
                badge.textContent = 'æœªæ£€æµ‹åˆ°ç‰©ä½“';
                badge.style.background = '#6c757d';
            }

            // ğŸ¯ æ›´æ–°é€šç”¨æ£€æµ‹ç±»åˆ«ç»Ÿè®¡
            updateObjectCategories(data.detections || []);
            updateRecentDetections(data.detections || []);
        }

        // ğŸ¯ æ–°å¢ï¼šæ›´æ–°é€šç”¨æ£€æµ‹ç±»åˆ«ç»Ÿè®¡
        function updateObjectCategories(detections) {
            const categoriesContainer = document.getElementById('objectCategories');

            if (detections.length === 0) {
                categoriesContainer.innerHTML = `
                    <div class="no-detections" style="text-align: center; color: #666; font-size: 12px; padding: 10px;">
                        æš‚æ— æ£€æµ‹ç»“æœ
                    </div>
                `;
                return;
            }

            // ç»Ÿè®¡å„ç±»åˆ«æ•°é‡
            const categoryCounts = {};
            detections.forEach(detection => {
                const className = detection.class_name || 'unknown';
                categoryCounts[className] = (categoryCounts[className] || 0) + 1;
            });

            // ç”Ÿæˆç±»åˆ«ç»Ÿè®¡HTML
            let categoriesHTML = '';
            for (const [className, count] of Object.entries(categoryCounts)) {
                const categoryInfo = getObjectCategoryInfo(className);
                categoriesHTML += `
                    <div class="object-category-item ${categoryInfo.cssClass}">
                        <div class="category-icon">${categoryInfo.icon}</div>
                        <div class="category-name">${categoryInfo.displayName}</div>
                        <div class="category-count">${count}</div>
                    </div>
                `;
            }

            categoriesContainer.innerHTML = categoriesHTML;
        }

        // ğŸ¯ æ–°å¢ï¼šè·å–ç‰©ä½“ç±»åˆ«ä¿¡æ¯
        function getObjectCategoryInfo(className) {
            const categoryMap = {
                'person': { icon: 'ğŸ‘¤', displayName: 'äººå‘˜', cssClass: 'person' },
                'car': { icon: 'ğŸš—', displayName: 'æ±½è½¦', cssClass: 'car' },
                'truck': { icon: 'ğŸšš', displayName: 'å¡è½¦', cssClass: 'car' },
                'bus': { icon: 'ğŸšŒ', displayName: 'å…¬äº¤è½¦', cssClass: 'car' },
                'motorcycle': { icon: 'ğŸï¸', displayName: 'æ‘©æ‰˜è½¦', cssClass: 'car' },
                'bicycle': { icon: 'ğŸš²', displayName: 'è‡ªè¡Œè½¦', cssClass: 'car' },
                'bottle': { icon: 'ğŸ¼', displayName: 'ç“¶å­', cssClass: 'bottle' },
                'cup': { icon: 'â˜•', displayName: 'æ¯å­', cssClass: 'bottle' },
                'chair': { icon: 'ğŸª‘', displayName: 'æ¤…å­', cssClass: 'chair' },
                'couch': { icon: 'ğŸ›‹ï¸', displayName: 'æ²™å‘', cssClass: 'chair' },
                'dining table': { icon: 'ğŸ½ï¸', displayName: 'é¤æ¡Œ', cssClass: 'chair' },
                'bed': { icon: 'ğŸ›ï¸', displayName: 'åºŠ', cssClass: 'chair' },
                'cell phone': { icon: 'ğŸ“±', displayName: 'æ‰‹æœº', cssClass: 'phone' },
                'laptop': { icon: 'ğŸ’»', displayName: 'ç¬”è®°æœ¬', cssClass: 'laptop' },
                'mouse': { icon: 'ğŸ–±ï¸', displayName: 'é¼ æ ‡', cssClass: 'laptop' },
                'keyboard': { icon: 'âŒ¨ï¸', displayName: 'é”®ç›˜', cssClass: 'laptop' },
                'tv': { icon: 'ğŸ“º', displayName: 'ç”µè§†', cssClass: 'laptop' },
                'book': { icon: 'ğŸ“š', displayName: 'ä¹¦ç±', cssClass: 'book' },
                'clock': { icon: 'â°', displayName: 'æ—¶é’Ÿ', cssClass: 'book' },
                'vase': { icon: 'ğŸº', displayName: 'èŠ±ç“¶', cssClass: 'book' },
                'potted plant': { icon: 'ğŸª´', displayName: 'ç›†æ ½', cssClass: 'book' },
                'dog': { icon: 'ğŸ•', displayName: 'ç‹—', cssClass: 'person' },
                'cat': { icon: 'ğŸˆ', displayName: 'çŒ«', cssClass: 'person' },
                'bird': { icon: 'ğŸ¦', displayName: 'é¸Ÿ', cssClass: 'person' },
                'apple': { icon: 'ğŸ', displayName: 'è‹¹æœ', cssClass: 'bottle' },
                'banana': { icon: 'ğŸŒ', displayName: 'é¦™è•‰', cssClass: 'bottle' },
                'orange': { icon: 'ğŸŠ', displayName: 'æ©™å­', cssClass: 'bottle' },
                'broccoli': { icon: 'ğŸ¥¦', displayName: 'è¥¿å…°èŠ±', cssClass: 'bottle' },
                'carrot': { icon: 'ğŸ¥•', displayName: 'èƒ¡èåœ', cssClass: 'bottle' }
            };

            return categoryMap[className] || {
                icon: 'ğŸ“¦',
                displayName: className.charAt(0).toUpperCase() + className.slice(1),
                cssClass: 'common'
            };
        }

        function updateRecentDetections(detections) {
            const list = document.getElementById('recentDetectionsList');
            if (detections.length === 0) {
                list.innerHTML = '<li>æš‚æ— æ£€æµ‹ç»“æœ</li>';
                return;
            }

            list.innerHTML = '';
            detections.slice(0, 5).forEach(detection => {
                const li = document.createElement('li');
                li.textContent = `${detection.class_name}: ${(detection.confidence * 100).toFixed(1)}%`;
                list.appendChild(li);
            });
        }

        function updateVideoFrame(data) {
            // ğŸ¯ æ›´æ–°é€šç”¨æ£€æµ‹é¢æ¿ï¼ˆåŸå§‹å›¾åƒï¼‰
            const videoFrame = document.getElementById('videoFrame');
            const placeholder = document.getElementById('videoPlaceholder');
            const overlay = document.getElementById('videoOverlay');
            const frameInfo = document.getElementById('frameInfo');
            const detectionCount = document.getElementById('detectionCount');

            // ğŸ“ æ›´æ–°è‰è“æ£€æµ‹é¢æ¿ï¼ˆåŸå§‹å›¾åƒï¼‰
            const strawberryFrame = document.getElementById('strawberryFrame');
            const strawberryPlaceholder = document.getElementById('strawberryPlaceholder');
            const strawberryOverlay = document.getElementById('strawberryOverlay');
            const strawberryFrameInfo = document.getElementById('strawberryFrameInfo');
            const strawberryCount = document.getElementById('strawberryCount');

            if (data.frame) {
                // ğŸ¯ é€šç”¨æ£€æµ‹é¢æ¿æ˜¾ç¤ºåŸå§‹å›¾åƒï¼ˆå¦‚æœæ²¡æœ‰å•ç‹¬çš„æ ‡æ³¨å›¾åƒï¼‰
                videoFrame.src = 'data:image/jpeg;base64,' + data.frame;
                videoFrame.style.display = 'block';
                placeholder.style.display = 'none';
                overlay.style.display = 'block';

                frameInfo.textContent = `Frame: ${data.frame_count || 0}`;
                detectionCount.textContent = `æ£€æµ‹: ${data.general_detection_count || 0} ä¸ªç‰©ä½“`;

                // ğŸ“ è‰è“æ£€æµ‹é¢æ¿æ˜¾ç¤ºåŸå§‹å›¾åƒï¼ˆå¦‚æœæ²¡æœ‰å•ç‹¬çš„æ ‡æ³¨å›¾åƒï¼‰
                strawberryFrame.src = 'data:image/jpeg;base64,' + data.frame;
                strawberryFrame.style.display = 'block';
                strawberryPlaceholder.style.display = 'none';
                strawberryOverlay.style.display = 'block';

                strawberryFrameInfo.textContent = `ğŸ“ ${data.image_filename || 'unknown'}`;
                strawberryCount.textContent = `è‰è“: ${data.strawberry_count || 0} ä¸ª`;

                updateCameraStatus({status: 'online'});
            }
        }

        // ğŸ¯ æ–°å¢ï¼šæ›´æ–°é€šç”¨æ£€æµ‹æ ‡æ³¨å›¾åƒ
        function updateGeneralFrame(data) {
            const videoFrame = document.getElementById('videoFrame');
            const placeholder = document.getElementById('videoPlaceholder');
            const overlay = document.getElementById('videoOverlay');
            const frameInfo = document.getElementById('frameInfo');
            const detectionCount = document.getElementById('detectionCount');

            if (data.frame) {
                videoFrame.src = 'data:image/jpeg;base64,' + data.frame;
                videoFrame.style.display = 'block';
                placeholder.style.display = 'none';
                overlay.style.display = 'block';

                frameInfo.textContent = `ğŸ¯ æ£€æµ‹æ ‡æ³¨: ${data.image_filename || 'unknown'}`;
                detectionCount.textContent = `æ£€æµ‹: ${data.detection_count || 0} ä¸ªç‰©ä½“`;

                console.log('ğŸ¯ é€šç”¨æ£€æµ‹æ ‡æ³¨å›¾åƒå·²æ›´æ–°');
            }
        }

        function updateSystemStatus(data) {
            const systemInfoList = document.getElementById('systemInfoList');
            systemInfoList.innerHTML = `
                <li>MQTT: ${data.mqtt_connected ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}</li>
                <li>é€šç”¨æ£€æµ‹: ${data.detection_enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}</li>
                <li>è‰è“æ£€æµ‹: ${strawberryEnabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}</li>
                <li>æµ‹è¯•æ¨¡å¼: ${data.test_mode ? 'æ˜¯' : 'å¦'}</li>
                <li>AIåŠ©æ‰‹: ${data.ai_enabled ? 'å·²è¿æ¥' : 'æœªè¿æ¥'}</li>
            `;
        }

        function updateMQTTStatus(data) {
            const statusDot = document.getElementById('mqttStatus');
            const statusText = document.getElementById('mqttText');

            if (data.connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'å·²è¿æ¥';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'æœªè¿æ¥';
            }
        }

        function updateCameraStatus(data) {
            const statusDot = document.getElementById('cameraStatus');
            const statusText = document.getElementById('cameraText');

            if (data.status === 'online') {
                statusDot.classList.add('connected');
                statusText.textContent = 'åœ¨çº¿';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'ç¦»çº¿';
            }
        }

        function updateAIStatus(data) {
            const statusDot = document.getElementById('aiStatus');
            const statusText = document.getElementById('aiText');
            const badge = document.getElementById('aiBadge');

            if (data.enabled && data.status === 'connected') {
                statusDot.classList.add('connected');
                statusText.textContent = 'å·²è¿æ¥';
                badge.textContent = 'å·²è¿æ¥';
                badge.style.background = '#28a745';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'æœªè¿æ¥';
                badge.textContent = 'æœªè¿æ¥';
                badge.style.background = '#dc3545';
            }
        }

        function requestSystemInfo() {
            if (socket && socket.connected) {
                socket.emit('request_sensors');
                socket.emit('request_detections');
            }
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¯·æ±‚è‰è“çŠ¶æ€
        setTimeout(() => {
            requestStrawberryStatus();
        }, 3000);

        // å®šæœŸæ›´æ–°è‰è“çŠ¶æ€
        setInterval(() => {
            if (strawberryEnabled) {
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å®šæœŸçŠ¶æ€æ£€æŸ¥
            }
        }, 30000); // æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡

        console.log('ğŸ“ å®Œæ•´ç‰ˆè‰è“æ£€æµ‹å‰ç«¯ä»£ç å·²åŠ è½½');
    </script>
</body>
</html>