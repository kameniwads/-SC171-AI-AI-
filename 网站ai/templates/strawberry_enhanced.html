<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üçì Â¢ûÂº∫ÁâàËçâËéìËØÜÂà´ÁõëÊéßÁ≥ªÁªü - ÂÆåÊï¥Áâà</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #feca57 50%, #48ca48 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            grid-template-rows: auto auto 1fr;
            gap: 20px;
            min-height: 100vh;
        }

        .header {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            text-align: center;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48ca48);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #f8f9fa;
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .status-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #2ed573;
        }

        .status-dot.warning {
            background: #ffa502;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .panel-title {
            font-size: 20px;
            font-weight: 600;
            color: #667eea;
        }

        .panel-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        /* ‰º†ÊÑüÂô®Èù¢Êùø */
        .sensors-panel {
            grid-column: 1;
            grid-row: 2;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            flex-grow: 1;
        }

        .sensor-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .sensor-card.optimal {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .sensor-card.good {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }

        .sensor-card.warning {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .sensor-card.danger {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .sensor-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .sensor-name {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .sensor-value {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 3px;
        }

        .sensor-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.7);
        }

        /* ÈÄöÁî®Ê£ÄÊµãÈù¢Êùø */
        .detection-panel {
            grid-column: 2;
            grid-row: 2;
        }

        /* üçì ËçâËéìÊ£ÄÊµãÈù¢Êùø */
        .strawberry-panel {
            grid-column: 3;
            grid-row: 2;
            border: 3px solid #ff6b6b;
        }

        .strawberry-panel .panel-title {
            color: #ff6b6b;
        }

        .strawberry-panel .panel-badge {
            background: #ff6b6b;
        }

        .video-container {
            flex-grow: 1;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-frame {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
        }

        .detection-info {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .detection-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
        }

        .stat-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: transform 0.2s ease;
        }

        .stat-item:hover {
            transform: scale(1.05);
        }

        .stat-value {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 10px;
            color: #666;
            margin-top: 3px;
        }

        /* üéØ ÈÄöÁî®Ê£ÄÊµãÁ±ªÂà´ÁªüËÆ°Ê†∑Âºè */
        .object-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .object-category-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.2s ease;
            position: relative;
        }

        .object-category-item:hover {
            transform: scale(1.05);
        }

        .object-category-item.person {
            border-color: #fd79a8;
            background: linear-gradient(135deg, #ffeef4 0%, #fdd8e7 100%);
        }

        .object-category-item.car {
            border-color: #74b9ff;
            background: linear-gradient(135deg, #e6f3ff 0%, #cce7ff 100%);
        }

        .object-category-item.bottle {
            border-color: #00b894;
            background: linear-gradient(135deg, #e6f7f3 0%, #ccf0e6 100%);
        }

        .object-category-item.chair {
            border-color: #e17055;
            background: linear-gradient(135deg, #fdf2f0 0%, #fbe5e1 100%);
        }

        .object-category-item.phone {
            border-color: #a29bfe;
            background: linear-gradient(135deg, #f4f3ff 0%, #e9e6ff 100%);
        }

        .object-category-item.book {
            border-color: #fdcb6e;
            background: linear-gradient(135deg, #fffbf0 0%, #fff2d9 100%);
        }

        .object-category-item.laptop {
            border-color: #6c5ce7;
            background: linear-gradient(135deg, #f1f0ff 0%, #e2e0ff 100%);
        }

        .object-category-item.common {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f1ff 0%, #e0e3ff 100%);
        }

        .category-icon {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .category-name {
            font-size: 11px;
            color: #666;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .category-count {
            font-size: 16px;
            font-weight: bold;
            color: #333;
        }

        .no-detections {
            grid-column: 1 / -1;
        }

        /* üçì ËçâËéìÁâπÊÆäÊ†∑Âºè */
        .strawberry-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .strawberry-stat-item {
            text-align: center;
            padding: 8px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.2s ease;
        }

        .strawberry-stat-item.ripe {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        }

        .strawberry-stat-item.nearly-ripe {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        }

        .strawberry-stat-item.unripe {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        }

        .strawberry-stat-item.rotten {
            border-color: #dc3545;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        }

        .strawberry-stat-item.harvest {
            border-color: #ff6b6b;
            background: linear-gradient(135deg, #ffecec 0%, #ffd3d3 100%);
        }

        .strawberry-stat-item.quality {
            border-color: #48ca48;
            background: linear-gradient(135deg, #e8f5e8 0%, #d1f2d1 100%);
        }

        /* ËçâËéìÊéßÂà∂ÊåâÈíÆ */
        .strawberry-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .strawberry-toggle {
            padding: 8px 15px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .strawberry-toggle:hover {
            background: #ff5252;
            transform: translateY(-2px);
        }

        .strawberry-toggle:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* AI ÂØπËØùÈù¢Êùø */
        .ai-panel {
            grid-column: 1 / -1;
            grid-row: 3;
            max-height: 600px;
        }

        .ai-config {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .ai-config input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            flex: 1;
            min-width: 200px;
        }

        .ai-config button {
            padding: 8px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .ai-config button:hover {
            background: #5a6fd8;
        }

        .ai-config button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .chat-container {
            display: flex;
            gap: 20px;
            flex-grow: 1;
            min-height: 400px;
        }

        .chat-messages {
            flex: 2;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            background: #fafafa;
            max-height: 400px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background: white;
            border: 1px solid #e9ecef;
        }

        .message.system {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #666;
            font-style: italic;
            text-align: center;
            max-width: 100%;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .chat-input-container {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .chat-send {
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .chat-send:hover {
            background: #218838;
        }

        .chat-send:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .system-info {
            flex: 1;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .info-section {
            margin-bottom: 20px;
        }

        .info-title {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }

        .info-list {
            list-style: none;
        }

        .info-list li {
            padding: 5px 0;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-list li:last-child {
            border-bottom: none;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #667eea;
        }

        .loading-dots {
            display: flex;
            gap: 3px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #667eea;
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1400px) {
            .container {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto auto;
            }

            .sensors-panel {
                grid-column: 1;
                grid-row: 2;
            }

            .detection-panel {
                grid-column: 2;
                grid-row: 2;
            }

            .strawberry-panel {
                grid-column: 1 / -1;
                grid-row: 3;
            }

            .ai-panel {
                grid-column: 1 / -1;
                grid-row: 4;
            }
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto auto;
            }

            .sensors-panel, .detection-panel, .strawberry-panel {
                grid-column: 1;
            }

            .sensors-panel { grid-row: 2; }
            .detection-panel { grid-row: 3; }
            .strawberry-panel { grid-row: 4; }
            .ai-panel { grid-row: 5; }

            .chat-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Â§¥ÈÉ®Áä∂ÊÄÅÊ†è -->
        <div class="header">
            <h1>üçì Â¢ûÂº∫ÁâàËçâËéìËØÜÂà´ÁõëÊéßÁ≥ªÁªü - ÂÆåÊï¥Áâà</h1>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="mqttStatus"></div>
                    <span>MQTT: <span id="mqttText">Êú™ËøûÊé•</span></span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="cameraStatus"></div>
                    <span>Áõ∏Êú∫: <span id="cameraText">Á¶ªÁ∫ø</span></span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="detectionStatus"></div>
                    <span>ÈÄöÁî®Ê£ÄÊµã: <span id="detectionText">ÂæÖÊú∫</span></span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="strawberryStatus"></div>
                    <span>üçìÊ£ÄÊµã: <span id="strawberryText">ÂæÖÊú∫</span></span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="aiStatus"></div>
                    <span>AI: <span id="aiText">Êú™ËøûÊé•</span></span>
                </div>
                <div class="status-item">
                    <span>ËøêË°åÊó∂Èó¥: <span id="uptime">00:00:00</span></span>
                </div>
            </div>
        </div>

        <!-- ‰º†ÊÑüÂô®Èù¢Êùø -->
        <div class="panel sensors-panel">
            <div class="panel-header">
                <div class="panel-title">üìä ‰º†ÊÑüÂô®ÁõëÊéß</div>
                <div class="panel-badge" id="sensorBadge">Á≠âÂæÖÊï∞ÊçÆ</div>
            </div>
            <div class="sensor-grid">
                <div class="sensor-card" id="temperatureCard">
                    <div class="sensor-icon">üå°Ô∏è</div>
                    <div class="sensor-name">Ê∏©Â∫¶</div>
                    <div class="sensor-value" id="temperatureValue">--</div>
                    <div class="sensor-status" id="temperatureStatus">Á≠âÂæÖÊï∞ÊçÆ</div>
                </div>
                <div class="sensor-card" id="humidityCard">
                    <div class="sensor-icon">üíß</div>
                    <div class="sensor-name">ÊπøÂ∫¶</div>
                    <div class="sensor-value" id="humidityValue">--</div>
                    <div class="sensor-status" id="humidityStatus">Á≠âÂæÖÊï∞ÊçÆ</div>
                </div>
                <div class="sensor-card" id="lightCard">
                    <div class="sensor-icon">‚òÄÔ∏è</div>
                    <div class="sensor-name">ÂÖâÁÖß</div>
                    <div class="sensor-value" id="lightValue">--</div>
                    <div class="sensor-status" id="lightStatus">Á≠âÂæÖÊï∞ÊçÆ</div>
                </div>
            </div>
        </div>

        <!-- ÈÄöÁî®Ê£ÄÊµãÈù¢Êùø -->
        <div class="panel detection-panel">
            <div class="panel-header">
                <div class="panel-title">üéØ ÈÄöÁî®Áâ©‰ΩìÊ£ÄÊµã</div>
                <div class="panel-badge" id="detectionBadge">ÂæÖÊú∫</div>
            </div>

            <div class="video-container">
                <img id="videoFrame" class="video-frame" style="display: none;" alt="Ê£ÄÊµãÁîªÈù¢">
                <div id="videoPlaceholder" style="color: white; text-align: center;">
                    <div style="font-size: 36px; margin-bottom: 15px;">üì∑</div>
                    <div>Á≠âÂæÖÂõæÂÉèÊï∞ÊçÆ...</div>
                </div>
                <div class="video-overlay" id="videoOverlay" style="display: none;">
                    <div id="frameInfo">Frame: 0</div>
                    <div id="detectionCount">Ê£ÄÊµã: 0 ‰∏™Áâ©‰Ωì</div>
                </div>
            </div>

            <div class="detection-info">
                <!-- Âü∫Á°ÄÁªüËÆ° -->
                <div class="detection-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="totalDetections">0</div>
                        <div class="stat-label">ÊÄªÊ£ÄÊµãÊï∞</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentDetections">0</div>
                        <div class="stat-label">ÂΩìÂâçÊ£ÄÊµã</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="processingTime">0.00s</div>
                        <div class="stat-label">Â§ÑÁêÜÊó∂Èó¥</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="currentImage">--</div>
                        <div class="stat-label">ÂΩìÂâçÂõæÁâá</div>
                    </div>
                </div>

                <!-- üéØ Ê£ÄÊµãÁ±ªÂà´ÁªüËÆ° -->
                <div style="margin-top: 15px;">
                    <div style="font-size: 14px; font-weight: 600; color: #667eea; margin-bottom: 10px; text-align: center;">
                        üéØ Ê£ÄÊµãÁ±ªÂà´ÁªüËÆ°
                    </div>
                    <div class="object-categories" id="objectCategories">
                        <div class="no-detections" style="text-align: center; color: #666; font-size: 12px; padding: 10px;">
                            ÊöÇÊó†Ê£ÄÊµãÁªìÊûú
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- üçì ËçâËéìÊ£ÄÊµãÈù¢Êùø -->
        <div class="panel strawberry-panel">
            <div class="panel-header">
                <div class="panel-title">üçì ËçâËéìÊàêÁÜüÂ∫¶Ê£ÄÊµã</div>
                <div class="panel-badge" id="strawberryBadge">ÂæÖÊú∫</div>
            </div>

            <div class="strawberry-controls">
                <button class="strawberry-toggle" id="strawberryToggle" onclick="toggleStrawberryDetection()">
                    ÂêØÁî®ËçâËéìÊ£ÄÊµã
                </button>
                <button class="strawberry-toggle" onclick="requestStrawberryStatus()">
                    Âà∑Êñ∞Áä∂ÊÄÅ
                </button>
                <button class="strawberry-toggle" onclick="debugStrawberryClasses()">
                    üîç Ë∞ÉËØï‰ø°ÊÅØ
                </button>
            </div>

            <div class="video-container">
                <img id="strawberryFrame" class="video-frame" style="display: none;" alt="ËçâËéìÊ£ÄÊµãÁîªÈù¢">
                <div id="strawberryPlaceholder" style="color: white; text-align: center;">
                    <div style="font-size: 36px; margin-bottom: 15px;">üçì</div>
                    <div>Á≠âÂæÖËçâËéìÊ£ÄÊµã...</div>
                </div>
                <div class="video-overlay" id="strawberryOverlay" style="display: none;">
                    <div id="strawberryFrameInfo">üçì Ê£ÄÊµã‰∏≠...</div>
                    <div id="strawberryCount">ËçâËéì: 0 ‰∏™</div>
                </div>
            </div>

            <div class="detection-info">
                <!-- üçì ÂΩìÂâçÊ£ÄÊµãÁªüËÆ° -->
                <div style="margin-top: 15px;">
                    <div style="font-size: 14px; font-weight: 600; color: #ff6b6b; margin-bottom: 10px; text-align: center;">
                        üçì ÂΩìÂâçÊ£ÄÊµãÊàêÁÜüÂ∫¶ÂàÜÂ∏É
                    </div>
                    <div class="strawberry-stats">
                        <div class="strawberry-stat-item ripe">
                            <div class="stat-value" id="ripeCount">0</div>
                            <div class="stat-label">üçì ÊàêÁÜü</div>
                        </div>
                        <div class="strawberry-stat-item nearly-ripe">
                            <div class="stat-value" id="nearlyRipeCount">0</div>
                            <div class="stat-label">üü° Êé•ËøëÊàêÁÜü</div>
                        </div>
                        <div class="strawberry-stat-item unripe">
                            <div class="stat-value" id="unripeCount">0</div>
                            <div class="stat-label">üîµ Êú™ÊàêÁÜü</div>
                        </div>
                        <div class="strawberry-stat-item rotten">
                            <div class="stat-value" id="rottenCount">0</div>
                            <div class="stat-label">üî¥ ËÖêÁÉÇ</div>
                        </div>
                        <div class="strawberry-stat-item harvest">
                            <div class="stat-value" id="harvestReady">0</div>
                            <div class="stat-label">üì¶ ÂèØÊî∂Ëé∑</div>
                        </div>
                        <div class="strawberry-stat-item quality">
                            <div class="stat-value" id="qualityScore">0%</div>
                            <div class="stat-label">‚ú® Ë¥®ÈáèËØÑÂàÜ</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI ÂØπËØùÈù¢Êùø -->
        <div class="panel ai-panel">
            <div class="panel-header">
                <div class="panel-title">üß† DeepSeek R1 AI Âä©Êâã</div>
                <div class="panel-badge" id="aiBadge">Êú™ËøûÊé•</div>
            </div>

            <div class="ai-config">
                <input type="text" id="aiApiUrl" placeholder="APIÂú∞ÂùÄ" value="http://localhost:11434">
                <input type="text" id="aiModelName" placeholder="Ê®°ÂûãÂêçÁß∞" value="deepseek-r1:1.5b">
                <button id="testAiBtn" onclick="testAI()">ÊµãËØïËøûÊé•</button>
                <button onclick="askGeneralAnalysis()">üéØ ÈÄöÁî®ÂàÜÊûê</button>
                <button onclick="askStrawberryAdvice()">üçì ËçâËéìÂª∫ËÆÆ</button>
            </div>

            <div class="chat-container">
                <div style="flex: 2;">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message system">
                            <div>ü§ñ Â¢ûÂº∫ÁâàAIÂä©ÊâãÂ∑≤ÂáÜÂ§áÂ∞±Áª™ÔºÅÊàëÂèØ‰ª•Â∏ÆÊÇ®ÂàÜÊûê‰º†ÊÑüÂô®Êï∞ÊçÆ„ÄÅËß£ËØªÊ£ÄÊµãÁªìÊûú„ÄÅÊèê‰æõËçâËéìÁßçÊ§çÂª∫ËÆÆÁ≠â„ÄÇ</div>
                            <div class="message-time" id="welcomeTime"></div>
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <textarea id="chatInput" class="chat-input" placeholder="ËæìÂÖ•ÊÇ®ÁöÑÈóÆÈ¢ò...‰æãÂ¶ÇÔºöÂàÜÊûêÂΩìÂâçËçâËéìÁä∂ÂÜµ„ÄÅÂ¶Ç‰ΩïÊèêÈ´òËçâËéìË¥®Èáè„ÄÅ‰ªÄ‰πàÊó∂ÂÄôÊî∂Ëé∑Ôºü"></textarea>
                        <button id="chatSend" class="chat-send" onclick="sendAIMessage()">ÂèëÈÄÅ</button>
                    </div>
                </div>

                <div class="system-info">
                    <div class="info-section">
                        <div class="info-title">üîß Á≥ªÁªüÁä∂ÊÄÅ</div>
                        <ul class="info-list" id="systemInfoList">
                            <li>Ê≠£Âú®Âä†ËΩΩÁ≥ªÁªü‰ø°ÊÅØ...</li>
                        </ul>
                    </div>

                    <div class="info-section">
                        <div class="info-title">üçì ËçâËéìÁªüËÆ°</div>
                        <ul class="info-list" id="strawberryInfoList">
                            <li>Á≠âÂæÖËçâËéìÊ£ÄÊµãÊï∞ÊçÆ...</li>
                        </ul>
                    </div>

                    <div class="info-section">
                        <div class="info-title">üìà ÊúÄËøëÊ£ÄÊµã</div>
                        <ul class="info-list" id="recentDetectionsList">
                            <li>ÊöÇÊó†Ê£ÄÊµãÁªìÊûú</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ÂÖ®Â±ÄÂèòÈáè
        let socket;
        let systemStartTime = Date.now();
        let isAIProcessing = false;
        let strawberryEnabled = false;

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            const welcomeTime = document.getElementById('welcomeTime');
            welcomeTime.textContent = new Date().toLocaleTimeString();

            // ËøûÊé•WebSocket
            initializeSocket();

            // ÂêØÂä®Áä∂ÊÄÅÊõ¥Êñ∞
            startStatusUpdates();

            // ËÅäÂ§©ËæìÂÖ•Ê°Ü‰∫ã‰ª∂
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendAIMessage();
                }
            });

            // ÂàùÂßãÊµãËØïAIËøûÊé•
            setTimeout(testAI, 1000);
        });

        // WebSocketËøûÊé•
        function initializeSocket() {
            try {
                socket = io();

                socket.on('connect', function() {
                    console.log('‚úÖ WebSocketËøûÊé•ÊàêÂäü');
                    addSystemMessage('‚úÖ Â∑≤ËøûÊé•Âà∞ÂÆåÊï¥ÁâàÊúçÂä°Âô®');
                });

                socket.on('disconnect', function() {
                    console.log('‚ùå WebSocketËøûÊé•Êñ≠ÂºÄ');
                    addSystemMessage('‚ùå ‰∏éÊúçÂä°Âô®Êñ≠ÂºÄËøûÊé•');
                });

                // ‰º†ÊÑüÂô®Êï∞ÊçÆÊõ¥Êñ∞
                socket.on('all_sensors', function(data) {
                    updateSensorDisplay(data);
                });

                socket.on('sensor_update', function(data) {
                    updateSingleSensor(data.sensor_type, data.data);
                });

                // ÈÄöÁî®Ê£ÄÊµãÁªìÊûúÊõ¥Êñ∞
                socket.on('detection_update', function(data) {
                    updateDetectionDisplay(data);
                });

                // üçì ËçâËéìÊ£ÄÊµãÁªìÊûúÊõ¥Êñ∞
                socket.on('strawberry_update', function(data) {
                    console.log('üçì Êî∂Âà∞ËçâËéìÊõ¥Êñ∞Êï∞ÊçÆ:', data);
                    updateStrawberryDisplay(data);
                });

                // ËßÜÈ¢ëÂ∏ßÊõ¥Êñ∞
                socket.on('video_frame', function(data) {
                    updateVideoFrame(data);
                });

                // üéØ ÈÄöÁî®Ê£ÄÊµãÊ†áÊ≥®ÂõæÂÉèÊõ¥Êñ∞
                socket.on('general_frame', function(data) {
                    updateGeneralFrame(data);
                });

                // üçì ËçâËéìÊ£ÄÊµãÊ†áÊ≥®ÂõæÂÉèÊõ¥Êñ∞
                socket.on('strawberry_frame', function(data) {
                    console.log('üçì Êî∂Âà∞ËçâËéìÊ†áÊ≥®ÂõæÂÉè');
                    updateStrawberryFrame(data);
                });

                // AIÂìçÂ∫î
                socket.on('ai_response', function(data) {
                    handleAIResponse(data);
                });

                socket.on('ai_processing', function(data) {
                    addAIMessage(data.message, 'user');
                    addLoadingMessage();
                });

                socket.on('ai_status', function(data) {
                    updateAIStatus(data);
                });

                // Á≥ªÁªüÁä∂ÊÄÅÊõ¥Êñ∞
                socket.on('status_update', function(data) {
                    updateSystemStatus(data);
                });

                socket.on('mqtt_status', function(data) {
                    updateMQTTStatus(data);
                });

                socket.on('camera_status', function(data) {
                    updateCameraStatus(data);
                });

            } catch (error) {
                console.error('‚ùå WebSocketÂàùÂßãÂåñÂ§±Ë¥•:', error);
                addSystemMessage('‚ùå WebSocketÂàùÂßãÂåñÂ§±Ë¥•');
            }
        }

        // üçì ËçâËéìÊ£ÄÊµãÁõ∏ÂÖ≥ÂáΩÊï∞ - ‰øÆÂ§çÁâà
        async function toggleStrawberryDetection() {
            const btn = document.getElementById('strawberryToggle');
            btn.disabled = true;
            btn.textContent = 'ÂàáÊç¢‰∏≠...';

            try {
                const response = await fetch('/api/strawberry/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    strawberryEnabled = result.enabled;
                    btn.textContent = strawberryEnabled ? 'Á¶ÅÁî®ËçâËéìÊ£ÄÊµã' : 'ÂêØÁî®ËçâËéìÊ£ÄÊµã';

                    updateStrawberryStatus();
                    addSystemMessage(`üçì ${result.message}`);
                } else {
                    addSystemMessage(`‚ùå ËçâËéìÊ£ÄÊµãÂàáÊç¢Â§±Ë¥•: ${result.error}`);
                }
            } catch (error) {
                addSystemMessage(`‚ùå ËçâËéìÊ£ÄÊµãÂàáÊç¢Â§±Ë¥•: ${error.message}`);
                console.error('‚ùå ËçâËéìÊ£ÄÊµãÂàáÊç¢ÈîôËØØ:', error);
            }

            btn.disabled = false;
        }

        async function requestStrawberryStatus() {
            try {
                const response = await fetch('/api/strawberry/status');
                const status = await response.json();

                strawberryEnabled = status.enabled;

                updateStrawberryStatus();

                const statusMsg = `üçì ËçâËéìÊ£ÄÊµãÁä∂ÊÄÅ: ${status.enabled ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®'}Ôºå` +
                                 `Ê®°Âûã: ${status.model_loaded ? 'Â∑≤Âä†ËΩΩ' : 'Êú™Âä†ËΩΩ'}`;

                addSystemMessage(statusMsg);

                console.log('üçì ËçâËéìÊ£ÄÊµãÁä∂ÊÄÅ:', status);

            } catch (error) {
                addSystemMessage(`‚ùå Ëé∑ÂèñËçâËéìÁä∂ÊÄÅÂ§±Ë¥•: ${error.message}`);
                console.error('‚ùå Ëé∑ÂèñËçâËéìÁä∂ÊÄÅÈîôËØØ:', error);
            }
        }

        function updateStrawberryStatus() {
            const statusDot = document.getElementById('strawberryStatus');
            const statusText = document.getElementById('strawberryText');
            const badge = document.getElementById('strawberryBadge');
            const toggle = document.getElementById('strawberryToggle');

            if (strawberryEnabled) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Â∑≤ÂêØÁî®';
                badge.textContent = 'Â∑≤ÂêØÁî®';
                badge.style.background = '#28a745';
                toggle.textContent = 'Á¶ÅÁî®ËçâËéìÊ£ÄÊµã';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Â∑≤Á¶ÅÁî®';
                badge.textContent = 'Â∑≤Á¶ÅÁî®';
                badge.style.background = '#dc3545';
                toggle.textContent = 'ÂêØÁî®ËçâËéìÊ£ÄÊµã';
            }
        }

        function updateStrawberryDisplay(data) {
            console.log('üçì Êõ¥Êñ∞ËçâËéìÊòæÁ§∫Êï∞ÊçÆ:', data);

            // Ëé∑ÂèñÁªüËÆ°Êï∞ÊçÆ
            const stats = data.stats || {};
            const currentRipeness = stats.current_ripeness || {};
            const totalRipeness = stats.ripeness_counts || {};

            // Êõ¥Êñ∞ÂΩìÂâçÂ∏ßÁöÑËçâËéìÊàêÁÜüÂ∫¶ÂàÜÂ∏É
            document.getElementById('ripeCount').textContent = currentRipeness['Ripe'] || 0;
            document.getElementById('nearlyRipeCount').textContent = currentRipeness['Nearly Ripe'] || 0;
            document.getElementById('unripeCount').textContent = currentRipeness['Unripe'] || 0;
            document.getElementById('rottenCount').textContent = currentRipeness['Rotten'] || 0;

            // Êõ¥Êñ∞Ë¥®ÈáèÊåáÊ†á
            document.getElementById('harvestReady').textContent = stats.current_harvest_ready || 0;
            document.getElementById('qualityScore').textContent = `${stats.current_quality_score || 0}%`;

            // Êõ¥Êñ∞badge
            const badge = document.getElementById('strawberryBadge');
            if (data.detection_count > 0) {
                badge.textContent = `üçì ${data.detection_count} ‰∏™ËçâËéì`;
                badge.style.background = '#ff6b6b';
            } else {
                badge.textContent = strawberryEnabled ? 'Êú™Ê£ÄÊµãÂà∞ËçâËéì' : 'Â∑≤Á¶ÅÁî®';
                badge.style.background = strawberryEnabled ? '#6c757d' : '#dc3545';
            }

            // Êõ¥Êñ∞Âè≥‰æß‰ø°ÊÅØÊ†èÁöÑËçâËéìÁªüËÆ°
            updateStrawberryInfo(stats, currentRipeness, totalRipeness);

            console.log('üçì ËçâËéìÊ£ÄÊµãÊï∞ÊçÆÊõ¥Êñ∞ÂÆåÊàê');
        }

        function updateStrawberryInfo(stats, currentRipeness, totalRipeness) {
            const list = document.getElementById('strawberryInfoList');

            if (!list) {
                console.warn('‚ö†Ô∏è Êú™ÊâæÂà∞ËçâËéì‰ø°ÊÅØÂàóË°®ÂÖÉÁ¥†');
                return;
            }

            // ËÆ°ÁÆóÊÄªÊï∞
            const currentTotal = Object.values(currentRipeness).reduce((sum, count) => sum + count, 0);
            const totalCount = Object.values(totalRipeness).reduce((sum, count) => sum + count, 0);

            // ÂàõÂª∫‰ø°ÊÅØÂàóË°®
            const infoItems = [
                `üçì ÂΩìÂâçÊ£ÄÊµã: ${currentTotal} ‰∏™ËçâËéì`,
                `üü¢ ÂΩìÂâçÊàêÁÜü: ${currentRipeness['Ripe'] || 0} ‰∏™`,
                `üü° Êé•ËøëÊàêÁÜü: ${currentRipeness['Nearly Ripe'] || 0} ‰∏™`,
                `üîµ Êú™ÊàêÁÜü: ${currentRipeness['Unripe'] || 0} ‰∏™`,
                `üî¥ ËÖêÁÉÇ: ${currentRipeness['Rotten'] || 0} ‰∏™`,
                `‚ú® ÂΩìÂâçË¥®Èáè: ${stats.current_quality_score || 0}%`,
                `üì¶ ÂèØÊî∂Ëé∑: ${stats.current_harvest_ready || 0} ‰∏™`,
                `üìä ÂéÜÂè≤ÊÄªÊï∞: ${totalCount} ‰∏™`,
                `‚è±Ô∏è Â§ÑÁêÜÊó∂Èó¥: ${(stats.processing_time || 0).toFixed(2)}s`
            ];

            list.innerHTML = infoItems.map(item => `<li>${item}</li>`).join('');
        }

        async function debugStrawberryClasses() {
            try {
                const response = await fetch('/api/strawberry/debug');
                const debugInfo = await response.json();

                console.log('üçì ËçâËéìÊ£ÄÊµãË∞ÉËØï‰ø°ÊÅØ:', debugInfo);

                let debugMessage = `üçì ËçâËéìÊ£ÄÊµãË∞ÉËØï‰ø°ÊÅØÔºö\n\n`;

                // ÈÖçÁΩÆ‰ø°ÊÅØ
                debugMessage += `üîß ÈÖçÁΩÆ‰ø°ÊÅØÔºö\n`;
                debugMessage += `- Ê£ÄÊµãÁä∂ÊÄÅ: ${debugInfo.enabled ? 'Â∑≤ÂêØÁî®' : 'Â∑≤Á¶ÅÁî®'}\n`;
                debugMessage += `- Ê®°ÂûãÂä†ËΩΩ: ${debugInfo.model_loaded ? 'Â∑≤Âä†ËΩΩ' : 'Êú™Âä†ËΩΩ'}\n`;
                debugMessage += `- Ê®°ÂûãË∑ØÂæÑ: ${debugInfo.model_path}\n`;
                debugMessage += `- ÈÖçÁΩÆÊñá‰ª∂: ${debugInfo.yaml_path}\n`;
                debugMessage += `- YAMLÂ≠òÂú®: ${debugInfo.yaml_exists ? 'ÊòØ' : 'Âê¶'}\n\n`;

                // Á±ªÂà´ÈÖçÁΩÆ
                debugMessage += `üçì Ê£ÄÊµãÁ±ªÂà´ (${debugInfo.class_count}‰∏™)Ôºö\n`;
                debugInfo.classes.forEach((className, index) => {
                    debugMessage += `- ID ${index}: ${className}\n`;
                });

                // ÂΩìÂâçÊ£ÄÊµãÂàÜÂ∏É
                debugMessage += `\nüìä ÂΩìÂâçÂ∏ßÊ£ÄÊµãÂàÜÂ∏ÉÔºö\n`;
                for (const [className, count] of Object.entries(debugInfo.current_ripeness || {})) {
                    debugMessage += `- ${className}: ${count}‰∏™\n`;
                }

                // ÂéÜÂè≤Á¥ØËÆ°ÁªüËÆ°
                debugMessage += `\nüìà ÂéÜÂè≤Á¥ØËÆ°ÁªüËÆ°Ôºö\n`;
                for (const [className, count] of Object.entries(debugInfo.total_ripeness || {})) {
                    debugMessage += `- ${className}: ${count}‰∏™\n`;
                }

                // ÊÄßËÉΩ‰ø°ÊÅØ
                debugMessage += `\n‚è±Ô∏è ÊÄßËÉΩ‰ø°ÊÅØÔºö\n`;
                debugMessage += `- Â§ÑÁêÜÊó∂Èó¥: ${(debugInfo.processing_time || 0).toFixed(2)}s\n`;
                debugMessage += `- ÊÄªÊ£ÄÊµãÊï∞: ${debugInfo.total_detections || 0}\n`;

                // ÊúÄËøëÊ£ÄÊµãËÆ∞ÂΩï
                if (debugInfo.last_detections && debugInfo.last_detections.length > 0) {
                    debugMessage += `\nüîç ÊúÄËøëÊ£ÄÊµãËÆ∞ÂΩïÔºö\n`;
                    debugInfo.last_detections.forEach((detection, index) => {
                        debugMessage += `${index + 1}. ${detection.class_name} (ÁΩÆ‰ø°Â∫¶: ${(detection.confidence * 100).toFixed(1)}%)\n`;
                    });
                } else {
                    debugMessage += `\nüîç ÊúÄËøëÊ£ÄÊµãËÆ∞ÂΩïÔºöÊöÇÊó†\n`;
                }

                alert(debugMessage);
                addSystemMessage('üîç ËçâËéìË∞ÉËØï‰ø°ÊÅØÂ∑≤ÊòæÁ§∫');

            } catch (error) {
                console.error('‚ùå Ëé∑ÂèñË∞ÉËØï‰ø°ÊÅØÂ§±Ë¥•:', error);
                addSystemMessage(`‚ùå Ëé∑ÂèñË∞ÉËØï‰ø°ÊÅØÂ§±Ë¥•: ${error.message}`);
            }
        }

        function updateStrawberryFrame(data) {
            const strawberryFrame = document.getElementById('strawberryFrame');
            const strawberryPlaceholder = document.getElementById('strawberryPlaceholder');
            const strawberryOverlay = document.getElementById('strawberryOverlay');
            const strawberryFrameInfo = document.getElementById('strawberryFrameInfo');
            const strawberryCount = document.getElementById('strawberryCount');

            if (data.frame) {
                try {
                    strawberryFrame.src = 'data:image/jpeg;base64,' + data.frame;
                    strawberryFrame.style.display = 'block';
                    strawberryPlaceholder.style.display = 'none';
                    strawberryOverlay.style.display = 'block';

                    strawberryFrameInfo.textContent = `üçì ËçâËéìÊ†áÊ≥®: ${data.image_filename || 'unknown'}`;
                    strawberryCount.textContent = `ËçâËéì: ${data.strawberry_count || 0} ‰∏™`;

                    console.log('üçì ËçâËéìÊ£ÄÊµãÊ†áÊ≥®ÂõæÂÉèÂ∑≤Êõ¥Êñ∞');
                } catch (error) {
                    console.error('üçì ËçâËéìÂõæÂÉèÊõ¥Êñ∞Â§±Ë¥•:', error);
                }
            }
        }

        // AIÂä©ÊâãÂ¢ûÂº∫ÁâàÂàÜÊûêÂáΩÊï∞ - Â∏¶Êï∞ÊçÆÁº∫Â§±Ê£ÄÊµã
        async function askGeneralAnalysis() {
            let detectionData = null;
            let sensorsData = null;
            let missingData = [];
            let contextInfo = "ËØ∑Âü∫‰∫é‰ª•‰∏ãÊï∞ÊçÆÊèê‰æõÈÄöÁî®Ê£ÄÊµãÂÆâÂÖ®ÊÄßÂíåÁõëÊéßÂàÜÊûêÔºö\n\n";

            // Â∞ùËØïËé∑ÂèñÊ£ÄÊµãÊï∞ÊçÆ
            try {
                const detectionResponse = await fetch('/api/detections');
                if (detectionResponse.ok) {
                    const responseData = await detectionResponse.json();
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØ‰ø°ÊÅØ
                    if (responseData.error) {
                        missingData.push(`ÈÄöÁî®Ê£ÄÊµãÊï∞ÊçÆ (${responseData.error})`);
                        console.warn('‚ö†Ô∏è ÈÄöÁî®Ê£ÄÊµãÊï∞ÊçÆÊúâÈîôËØØ:', responseData.error);
                    } else {
                        detectionData = responseData;
                        console.log('‚úÖ ÊàêÂäüËé∑ÂèñÈÄöÁî®Ê£ÄÊµãÊï∞ÊçÆ');
                    }
                } else {
                    missingData.push('ÈÄöÁî®Ê£ÄÊµãÊï∞ÊçÆ');
                    console.warn('‚ö†Ô∏è ÈÄöÁî®Ê£ÄÊµãÊï∞ÊçÆËé∑ÂèñÂ§±Ë¥•');
                }
            } catch (error) {
                missingData.push('ÈÄöÁî®Ê£ÄÊµãÊï∞ÊçÆ');
                console.error('‚ùå ÈÄöÁî®Ê£ÄÊµãÊï∞ÊçÆËØ∑Ê±ÇÂºÇÂ∏∏:', error);
            }

            // Â∞ùËØïËé∑Âèñ‰º†ÊÑüÂô®Êï∞ÊçÆ
            try {
                const sensorsResponse = await fetch('/api/sensors');
                if (sensorsResponse.ok) {
                    const responseData = await sensorsResponse.json();
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØÊàñË≠¶Âëä‰ø°ÊÅØ
                    if (responseData.error) {
                        missingData.push(`ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆ (${responseData.error})`);
                        console.warn('‚ö†Ô∏è ‰º†ÊÑüÂô®Êï∞ÊçÆÊúâÈîôËØØ:', responseData.error);
                    } else if (responseData.warning) {
                        missingData.push(`ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆ (${responseData.warning})`);
                        console.warn('‚ö†Ô∏è ‰º†ÊÑüÂô®Êï∞ÊçÆË≠¶Âëä:', responseData.warning);
                    } else {
                        sensorsData = responseData;
                        console.log('‚úÖ ÊàêÂäüËé∑Âèñ‰º†ÊÑüÂô®Êï∞ÊçÆ');
                    }
                } else {
                    missingData.push('ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆ');
                    console.warn('‚ö†Ô∏è ‰º†ÊÑüÂô®Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•');
                }
            } catch (error) {
                missingData.push('ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆ');
                console.error('‚ùå ‰º†ÊÑüÂô®Êï∞ÊçÆËØ∑Ê±ÇÂºÇÂ∏∏:', error);
            }

            // Â§ÑÁêÜÊï∞ÊçÆÁº∫Â§±ÊÉÖÂÜµ
            if (missingData.length > 0) {
                contextInfo += `‚ö†Ô∏è Êï∞ÊçÆÁº∫Â§±Ë≠¶ÂëäÔºö\n`;
                missingData.forEach(dataType => {
                    contextInfo += `- Áº∫Â§±Ôºö${dataType}\n`;
                });
                contextInfo += `\nËØ∑Âü∫‰∫éÂèØÁî®Êï∞ÊçÆËøõË°åÂàÜÊûêÔºåÂπ∂ËØ¥ÊòéÊï∞ÊçÆÁº∫Â§±ÂØπÂàÜÊûêÁªìÊûúÁöÑÂΩ±Âìç„ÄÇ\n\n`;
            }

            // === ÈÄöÁî®Ê£ÄÊµãÊï∞ÊçÆÂàÜÊûê ===
            if (detectionData) {
                contextInfo += "üéØ ÈÄöÁî®Áâ©‰ΩìÊ£ÄÊµãÊï∞ÊçÆÔºö\n";
                if (detectionData.detection_count > 0) {
                    contextInfo += `üìä Ê£ÄÊµãÊ¶ÇÂÜµÔºö\n`;
                    contextInfo += `- ÊÄªÊ£ÄÊµãÁâ©‰ΩìÊï∞: ${detectionData.detection_count}‰∏™\n`;
                    contextInfo += `- Â§ÑÁêÜÊó∂Èó¥: ${(detectionData.detection_stats?.processing_time || 0).toFixed(2)}Áßí\n`;
                    contextInfo += `- ÂéÜÂè≤ÊÄªÊ£ÄÊµãÊï∞: ${detectionData.detection_stats?.total_detections || 0}‰∏™\n\n`;

                    // ÂΩìÂâçÊ£ÄÊµãÂà∞ÁöÑÁâ©‰ΩìÁ±ªÂà´ÂíåÊï∞Èáè
                    if (detectionData.current_objects && Object.keys(detectionData.current_objects).length > 0) {
                        contextInfo += `üéØ ÂΩìÂâçÊ£ÄÊµãÂà∞ÁöÑÁâ©‰ΩìÁ±ªÂà´ÂíåÊï∞ÈáèÔºö\n`;
                        for (const [className, count] of Object.entries(detectionData.current_objects)) {
                            contextInfo += `- ${className}: ${count}‰∏™\n`;
                        }
                        contextInfo += `\n`;
                    }

                    // ÂéÜÂè≤Á¥ØËÆ°Ê£ÄÊµãÁªüËÆ°
                    if (detectionData.category_distribution && Object.keys(detectionData.category_distribution).length > 0) {
                        contextInfo += `üìà ÂéÜÂè≤Ê£ÄÊµãÁ±ªÂà´ÂàÜÂ∏ÉÊØî‰æãÔºö\n`;
                        for (const [className, percentage] of Object.entries(detectionData.category_distribution)) {
                            contextInfo += `- ${className}: ${percentage}%\n`;
                        }
                        contextInfo += `\n`;
                    }

                    // Ê£ÄÊµãÊÄªÁªì
                    if (detectionData.summary) {
                        contextInfo += `üìã Ê£ÄÊµãÊÄªÁªì: ${detectionData.summary}\n\n`;
                    }
                } else {
                    contextInfo += "‚ùå ÂΩìÂâçÊú™Ê£ÄÊµãÂà∞‰ªª‰ΩïÁâ©‰Ωì\n\n";
                }
            } else {
                contextInfo += "‚ùå ÈÄöÁî®Ê£ÄÊµãÊï∞ÊçÆ‰∏çÂèØÁî®\n\n";
            }

            // === ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆÂàÜÊûê ===
            if (sensorsData) {
                contextInfo += "üå°Ô∏è ÁéØÂ¢ÉÁõëÊµãÊï∞ÊçÆÔºö\n";
                const sensors = sensorsData.sensor_data || {};

                // Ê∏©Â∫¶Êï∞ÊçÆ
                if (sensors.temperature && sensors.temperature.value !== null) {
                    contextInfo += `- Ê∏©Â∫¶: ${sensors.temperature.value}¬∞C (Áä∂ÊÄÅ: ${getStatusText(sensors.temperature.status)})\n`;
                } else {
                    contextInfo += `- Ê∏©Â∫¶: Êó†Êï∞ÊçÆ\n`;
                }

                // ÊπøÂ∫¶Êï∞ÊçÆ
                if (sensors.humidity && sensors.humidity.value !== null) {
                    contextInfo += `- ÊπøÂ∫¶: ${sensors.humidity.value}% (Áä∂ÊÄÅ: ${getStatusText(sensors.humidity.status)})\n`;
                } else {
                    contextInfo += `- ÊπøÂ∫¶: Êó†Êï∞ÊçÆ\n`;
                }

                // ÂÖâÁÖßÊï∞ÊçÆ
                if (sensors.light && sensors.light.value !== null) {
                    contextInfo += `- ÂÖâÁÖß: ${sensors.light.value}lux (Áä∂ÊÄÅ: ${getStatusText(sensors.light.status)})\n`;
                } else {
                    contextInfo += `- ÂÖâÁÖß: Êó†Êï∞ÊçÆ\n`;
                }
                contextInfo += `\n`;
            } else {
                contextInfo += "‚ùå ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆ‰∏çÂèØÁî®\n\n";
            }

            // === ÂàÜÊûêË¶ÅÊ±Ç ===
            contextInfo += "üîç ËØ∑ËøõË°åÁªºÂêàÂàÜÊûêÂπ∂Êèê‰æõÂª∫ËÆÆÔºö\n\n";

            if (detectionData) {
                contextInfo += "üéØ Ê£ÄÊµãÁªìÊûúÂàÜÊûêÔºö\n";
                contextInfo += "1. ÁéØÂ¢ÉÂÆâÂÖ®ÊÄßËØÑ‰º∞ÔºàÊòØÂê¶ÊúâÂºÇÂ∏∏Áâ©‰ΩìÔºâ\n";
                contextInfo += "2. ÁõëÊéßÂå∫ÂüüÁä∂ÂÜµÂàÜÊûê\n";
                contextInfo += "3. ÊΩúÂú®È£éÈô©ËØÜÂà´\n";
                contextInfo += "4. Â¶ÇÊûúÊ£ÄÊµãÂà∞‰∫∫ÂëòÔºåÂàÜÊûêÊ¥ªÂä®Ê®°Âºè\n";
                contextInfo += "5. ËÆæÂ§áÊàñÂ∑•ÂÖ∑ÁöÑ‰ΩøÁî®ÊÉÖÂÜµÂàÜÊûê\n\n";
            }

            if (sensorsData) {
                contextInfo += "üå°Ô∏è ÁéØÂ¢ÉÊù°‰ª∂ÂàÜÊûêÔºö\n";
                contextInfo += "1. ËØÑ‰º∞ÂΩìÂâçÁéØÂ¢ÉÂèÇÊï∞ÊòØÂê¶Ê≠£Â∏∏\n";
                contextInfo += "2. ÂàÜÊûêÁéØÂ¢ÉÂØπÁõëÊéßÊïàÊûúÁöÑÂΩ±Âìç\n";
                contextInfo += "3. Êèê‰æõÁéØÂ¢É‰ºòÂåñÂª∫ËÆÆ\n\n";
            }

            contextInfo += "üí° ÁªºÂêàÂª∫ËÆÆÔºö\n";
            contextInfo += "1. ÁõëÊéßÁ≥ªÁªü‰ºòÂåñÂª∫ËÆÆ\n";
            contextInfo += "2. ÂÆâÂÖ®Èò≤Êä§Êé™ÊñΩ\n";
            contextInfo += "3. ÂºÇÂ∏∏ÊÉÖÂÜµÂ§ÑÁêÜÊñπÊ°à";

            if (missingData.length > 0) {
                contextInfo += `\n\n‚ö†Ô∏è Ê≥®ÊÑèÔºöÁî±‰∫éÁº∫Â§±${missingData.join('„ÄÅ')}ÔºåËØ∑Âú®ÂàÜÊûê‰∏≠ËØ¥ÊòéËøô‰∫õÊï∞ÊçÆÁº∫Â§±ÂØπÁªìËÆ∫ÁöÑÂΩ±Âìç„ÄÇ`;
            }

            document.getElementById('chatInput').value = contextInfo;
            sendAIMessage();
        }

        // AIÂä©ÊâãËØ¢ÈóÆËçâËéìÂª∫ËÆÆÂáΩÊï∞ - Â¢ûÂº∫ÁâàÔºàÂ∏¶Êï∞ÊçÆÁº∫Â§±Ê£ÄÊµãÔºâ
        async function askStrawberryAdvice() {
            let strawberryData = null;
            let sensorsData = null;
            let missingData = [];
            let contextInfo = "ËØ∑Âü∫‰∫é‰ª•‰∏ãÊï∞ÊçÆÊèê‰æõ‰∏ì‰∏öÁöÑËçâËéìÁßçÊ§çÂàÜÊûêÂíåÂª∫ËÆÆÔºö\n\n";

            // Â∞ùËØïËé∑ÂèñËçâËéìÊ£ÄÊµãÊï∞ÊçÆ
            try {
                const strawberryResponse = await fetch('/api/strawberry/detections');
                if (strawberryResponse.ok) {
                    const responseData = await strawberryResponse.json();
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØ‰ø°ÊÅØ
                    if (responseData.error) {
                        missingData.push(`ËçâËéìÊ£ÄÊµãÊï∞ÊçÆ (${responseData.error})`);
                        console.warn('‚ö†Ô∏è ËçâËéìÊ£ÄÊµãÊï∞ÊçÆÊúâÈîôËØØ:', responseData.error);
                    } else {
                        strawberryData = responseData;
                        console.log('‚úÖ ÊàêÂäüËé∑ÂèñËçâËéìÊ£ÄÊµãÊï∞ÊçÆ');
                    }
                } else {
                    missingData.push('ËçâËéìÊ£ÄÊµãÊï∞ÊçÆ');
                    console.warn('‚ö†Ô∏è ËçâËéìÊ£ÄÊµãÊï∞ÊçÆËé∑ÂèñÂ§±Ë¥•');
                }
            } catch (error) {
                missingData.push('ËçâËéìÊ£ÄÊµãÊï∞ÊçÆ');
                console.error('‚ùå ËçâËéìÊ£ÄÊµãÊï∞ÊçÆËØ∑Ê±ÇÂºÇÂ∏∏:', error);
            }

            // Â∞ùËØïËé∑Âèñ‰º†ÊÑüÂô®Êï∞ÊçÆ
            try {
                const sensorsResponse = await fetch('/api/sensors');
                if (sensorsResponse.ok) {
                    const responseData = await sensorsResponse.json();
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÈîôËØØÊàñË≠¶Âëä‰ø°ÊÅØ
                    if (responseData.error) {
                        missingData.push(`ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆ (${responseData.error})`);
                        console.warn('‚ö†Ô∏è ‰º†ÊÑüÂô®Êï∞ÊçÆÊúâÈîôËØØ:', responseData.error);
                    } else if (responseData.warning) {
                        missingData.push(`ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆ (${responseData.warning})`);
                        console.warn('‚ö†Ô∏è ‰º†ÊÑüÂô®Êï∞ÊçÆË≠¶Âëä:', responseData.warning);
                    } else {
                        sensorsData = responseData;
                        console.log('‚úÖ ÊàêÂäüËé∑Âèñ‰º†ÊÑüÂô®Êï∞ÊçÆ');
                    }
                } else {
                    missingData.push('ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆ');
                    console.warn('‚ö†Ô∏è ‰º†ÊÑüÂô®Êï∞ÊçÆËé∑ÂèñÂ§±Ë¥•');
                }
            } catch (error) {
                missingData.push('ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆ');
                console.error('‚ùå ‰º†ÊÑüÂô®Êï∞ÊçÆËØ∑Ê±ÇÂºÇÂ∏∏:', error);
            }

            // Â§ÑÁêÜÊï∞ÊçÆÁº∫Â§±ÊÉÖÂÜµ
            if (missingData.length > 0) {
                contextInfo += `‚ö†Ô∏è Êï∞ÊçÆÁº∫Â§±Ë≠¶ÂëäÔºö\n`;
                missingData.forEach(dataType => {
                    contextInfo += `- Áº∫Â§±Ôºö${dataType}\n`;
                });
                contextInfo += `\nËØ∑Âü∫‰∫éÂèØÁî®Êï∞ÊçÆËøõË°åÂàÜÊûêÔºåÂπ∂ËØ¥ÊòéÊï∞ÊçÆÁº∫Â§±ÂØπÁßçÊ§çÂª∫ËÆÆÁöÑÂΩ±Âìç„ÄÇ\n\n`;
            }

            // === ËçâËéìÊ£ÄÊµãÊï∞ÊçÆÂàÜÊûê ===
            if (strawberryData) {
                contextInfo += "üçì ËçâËéìÊ£ÄÊµãÁä∂ÂÜµÔºö\n";
                if (strawberryData.detection_count > 0) {
                    contextInfo += `- ÂΩìÂâçÊ£ÄÊµãÂà∞: ${strawberryData.detection_count}‰∏™ËçâËéì\n`;

                    // ËØ¶ÁªÜÊàêÁÜüÂ∫¶ÂàÜÂ∏É
                    if (strawberryData.detection_stats?.current_ripeness) {
                        contextInfo += "- ÊàêÁÜüÂ∫¶ÂàÜÂ∏ÉÔºö\n";
                        const ripeness = strawberryData.detection_stats.current_ripeness;
                        if (ripeness['Ripe'] > 0) contextInfo += `  * ÊàêÁÜü(Ripe): ${ripeness['Ripe']}‰∏™\n`;
                        if (ripeness['Nearly Ripe'] > 0) contextInfo += `  * Êé•ËøëÊàêÁÜü(Nearly Ripe): ${ripeness['Nearly Ripe']}‰∏™\n`;
                        if (ripeness['Unripe'] > 0) contextInfo += `  * Êú™ÊàêÁÜü(Unripe): ${ripeness['Unripe']}‰∏™\n`;
                        if (ripeness['Rotten'] > 0) contextInfo += `  * ËÖêÁÉÇ(Rotten): ${ripeness['Rotten']}‰∏™\n`;
                    }

                    // Ë¥®ÈáèÊåáÊ†á
                    contextInfo += `- ÂΩìÂâçË¥®ÈáèËØÑÂàÜ: ${strawberryData.detection_stats?.current_quality_score || 0}%\n`;
                    contextInfo += `- ÂèØÊî∂Ëé∑Êï∞Èáè: ${strawberryData.detection_stats?.current_harvest_ready || 0}‰∏™\n`;

                    // ÂéÜÂè≤ÁªüËÆ°
                    if (strawberryData.detection_stats?.total_detections) {
                        contextInfo += `- ÂéÜÂè≤ÊÄªÊ£ÄÊµãÊï∞: ${strawberryData.detection_stats.total_detections}‰∏™\n`;
                    }
                } else {
                    contextInfo += "- ‚ùå ÂΩìÂâçÊú™Ê£ÄÊµãÂà∞ËçâËéì\n";
                }
                contextInfo += `\n`;
            } else {
                contextInfo += "‚ùå ËçâËéìÊ£ÄÊµãÊï∞ÊçÆ‰∏çÂèØÁî®\n\n";
            }

            // === ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆÂàÜÊûê ===
            if (sensorsData) {
                contextInfo += "üå°Ô∏è ÁéØÂ¢ÉÁõëÊµãÊï∞ÊçÆÔºö\n";
                const sensors = sensorsData.sensor_data || {};

                // Ê∏©Â∫¶Êï∞ÊçÆ
                if (sensors.temperature && sensors.temperature.value !== null) {
                    contextInfo += `- Ê∏©Â∫¶: ${sensors.temperature.value}¬∞C (Áä∂ÊÄÅ: ${getStatusText(sensors.temperature.status)})\n`;
                } else {
                    contextInfo += `- Ê∏©Â∫¶: Êó†Êï∞ÊçÆ\n`;
                }

                // ÊπøÂ∫¶Êï∞ÊçÆ
                if (sensors.humidity && sensors.humidity.value !== null) {
                    contextInfo += `- ÊπøÂ∫¶: ${sensors.humidity.value}% (Áä∂ÊÄÅ: ${getStatusText(sensors.humidity.status)})\n`;
                } else {
                    contextInfo += `- ÊπøÂ∫¶: Êó†Êï∞ÊçÆ\n`;
                }

                // ÂÖâÁÖßÊï∞ÊçÆ
                if (sensors.light && sensors.light.value !== null) {
                    contextInfo += `- ÂÖâÁÖß: ${sensors.light.value}lux (Áä∂ÊÄÅ: ${getStatusText(sensors.light.status)})\n`;
                } else {
                    contextInfo += `- ÂÖâÁÖß: Êó†Êï∞ÊçÆ\n`;
                }
                contextInfo += `\n`;
            } else {
                contextInfo += "‚ùå ÁéØÂ¢É‰º†ÊÑüÂô®Êï∞ÊçÆ‰∏çÂèØÁî®\n\n";
            }

            // === ÂàÜÊûêË¶ÅÊ±Ç ===
            contextInfo += "üîç ËØ∑ËøõË°åÁªºÂêàÂàÜÊûêÂπ∂Êèê‰æõÂª∫ËÆÆÔºö\n\n";

            if (strawberryData) {
                contextInfo += "üìã ËçâËéìÁä∂ÂÜµÂàÜÊûêÔºö\n";
                contextInfo += "1. Ê†πÊçÆÊàêÁÜüÂ∫¶ÂàÜÂ∏ÉËØÑ‰º∞ÂΩìÂâçËçâËéìÂèëËÇ≤Áä∂ÂÜµ\n";
                contextInfo += "2. ÂàÜÊûêË¥®ÈáèËØÑÂàÜÔºåËØÜÂà´ÊΩúÂú®ÈóÆÈ¢ò\n";
                contextInfo += "3. Âà§Êñ≠ÊúÄ‰Ω≥Êî∂Ëé∑Êó∂Êú∫ÂíåÊî∂Ëé∑Á≠ñÁï•\n";
                contextInfo += "4. Â¶ÇÂèëÁé∞ËÖêÁÉÇËçâËéìÔºåÊèê‰æõÂ§ÑÁêÜÂª∫ËÆÆ\n\n";
            }

            if (sensorsData) {
                contextInfo += "üå± ÁéØÂ¢ÉÊù°‰ª∂ÂàÜÊûêÔºö\n";
                contextInfo += "1. ËØÑ‰º∞ÂΩìÂâçÊ∏©Â∫¶ÊòØÂê¶ÈÄÇÂÆúËçâËéìÁîüÈïøÔºàÊúÄÈÄÇ18-25¬∞CÔºâ\n";
                contextInfo += "2. ÂàÜÊûêÊπøÂ∫¶Ê∞¥Âπ≥ÊòØÂê¶ÂêàÁêÜÔºàÊúÄÈÄÇ60-80%Ôºâ\n";
                contextInfo += "3. Âà§Êñ≠ÂÖâÁÖßÂº∫Â∫¶ÊòØÂê¶ÂÖÖË∂≥ÔºàÊúÄÈÄÇ15000-35000luxÔºâ\n";
                contextInfo += "4. ËØÜÂà´ÁéØÂ¢ÉÂèÇÊï∞‰∏≠ÁöÑÂºÇÂ∏∏ÊàñÈ£éÈô©Âõ†Â≠ê\n\n";
            }

            contextInfo += "üí° ÁßçÊ§çÁÆ°ÁêÜÂª∫ËÆÆÔºö\n";

            if (sensorsData) {
                contextInfo += "1. Âü∫‰∫éÁéØÂ¢ÉÊï∞ÊçÆÊèê‰æõÊµáÊ∞¥„ÄÅÈÄöÈ£é„ÄÅÂÖâÁÖßË∞ÉËäÇÂª∫ËÆÆ\n";
                contextInfo += "2. Ê†πÊçÆËçâËéìÂèëËÇ≤Èò∂ÊÆµÁªôÂá∫ÊñΩËÇ•Âª∫ËÆÆ\n";
                contextInfo += "3. Êèê‰æõÁóÖËô´ÂÆ≥È¢ÑÈò≤Êé™ÊñΩ\n";
            } else {
                contextInfo += "1. Êèê‰æõÈÄöÁî®ÁöÑËçâËéìÁßçÊ§çÁÆ°ÁêÜÂª∫ËÆÆ\n";
                contextInfo += "2. Âü∫‰∫éËçâËéìÁä∂ÂÜµÁªôÂá∫Êä§ÁêÜÂª∫ËÆÆ\n";
            }

            contextInfo += "4. ÁªôÂá∫Êú™Êù•3-7Â§©ÁöÑÁÆ°ÁêÜËÆ°Âàí\n";
            contextInfo += "5. Â¶ÇÊúâÂºÇÂ∏∏ÊåáÊ†áÔºåÊèê‰æõÁ¥ßÊÄ•Â§ÑÁêÜÊñπÊ°à";

            if (missingData.length > 0) {
                contextInfo += `\n\n‚ö†Ô∏è Ê≥®ÊÑèÔºöÁî±‰∫éÁº∫Â§±${missingData.join('„ÄÅ')}ÔºåËØ∑Âú®Âª∫ËÆÆ‰∏≠ËØ¥ÊòéËøô‰∫õÊï∞ÊçÆÁº∫Â§±ÂØπÁßçÊ§çÁÆ°ÁêÜÂª∫ËÆÆÁöÑÂΩ±ÂìçÔºåÂπ∂Êèê‰æõÁõ∏Â∫îÁöÑÊõø‰ª£ÊñπÊ°à„ÄÇ`;
            }

            document.getElementById('chatInput').value = contextInfo;
            sendAIMessage();
        }

        // AIÁõ∏ÂÖ≥ÂáΩÊï∞
        async function testAI() {
            const btn = document.getElementById('testAiBtn');
            const apiUrl = document.getElementById('aiApiUrl').value;
            const modelName = document.getElementById('aiModelName').value;

            btn.disabled = true;
            btn.textContent = 'ÊµãËØï‰∏≠...';

            try {
                const response = await fetch('/api/ai/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_url: apiUrl,
                        model_name: modelName
                    })
                });

                const result = await response.json();

                if (result.success) {
                    addSystemMessage(`‚úÖ AIËøûÊé•ÊàêÂäüÔºÅÊ®°Âûã: ${result.model_name}`);
                    updateAIStatus({
                        enabled: true,
                        status: 'connected'
                    });
                } else {
                    addSystemMessage(`‚ùå AIËøûÊé•Â§±Ë¥•: ${result.error || 'Êú™Áü•ÈîôËØØ'}`);
                    updateAIStatus({
                        enabled: false,
                        status: result.status || 'error'
                    });
                }
            } catch (error) {
                console.error('‚ùå AIÊµãËØïÂ§±Ë¥•:', error);
                addSystemMessage(`‚ùå AIÊµãËØïÂ§±Ë¥•: ${error.message}`);
                updateAIStatus({
                    enabled: false,
                    status: 'error'
                });
            }

            btn.disabled = false;
            btn.textContent = 'ÊµãËØïËøûÊé•';
        }

        function sendAIMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSend');
            const message = input.value.trim();

            if (!message || isAIProcessing) return;

            isAIProcessing = true;
            sendBtn.disabled = true;
            sendBtn.textContent = 'ÂèëÈÄÅ‰∏≠...';

            // ÈÄöËøáWebSocketÂèëÈÄÅÊ∂àÊÅØ
            socket.emit('ai_message', {
                message: message,
                context: null
            });

            input.value = '';
        }

        function handleAIResponse(data) {
            removeLoadingMessage();

            if (data.error) {
                addAIMessage(`‚ùå ÈîôËØØ: ${data.error}`, 'ai');
            } else if (data.response) {
                addAIMessage(data.response, 'ai');
            }

            isAIProcessing = false;
            const sendBtn = document.getElementById('chatSend');
            sendBtn.disabled = false;
            sendBtn.textContent = 'ÂèëÈÄÅ';
        }

        function addAIMessage(content, sender) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const time = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `
                <div style="white-space: pre-wrap;">${content}</div>
                <div class="message-time">${time}</div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addSystemMessage(content) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';

            const time = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `
                <div>${content}</div>
                <div class="message-time">${time}</div>
            `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addLoadingMessage() {
            const chatMessages = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message ai loading-message';
            loadingDiv.id = 'loadingMessage';
            loadingDiv.innerHTML = `
                <div class="loading">
                    <span>AIÊ≠£Âú®ÊÄùËÄÉ</span>
                    <div class="loading-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;

            chatMessages.appendChild(loadingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.remove();
            }
        }

        // ÂÖ∂‰ªñÊõ¥Êñ∞ÂáΩÊï∞Ôºà‰øùÊåÅÂéüÊúâÈÄªËæëÔºâ
        function startStatusUpdates() {
            setInterval(function() {
                updateUptime();
                requestSystemInfo();
            }, 1000);
        }

        function updateUptime() {
            const uptime = Math.floor((Date.now() - systemStartTime) / 1000);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;

            document.getElementById('uptime').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateSensorDisplay(sensors) {
            for (const [sensorType, data] of Object.entries(sensors)) {
                updateSingleSensor(sensorType, data);
            }
        }

        function updateSingleSensor(sensorType, data) {
            const valueElement = document.getElementById(`${sensorType}Value`);
            const statusElement = document.getElementById(`${sensorType}Status`);
            const cardElement = document.getElementById(`${sensorType}Card`);

            if (valueElement && statusElement && cardElement) {
                if (data.value !== null) {
                    valueElement.textContent = `${data.value}${data.unit}`;
                    statusElement.textContent = getStatusText(data.status);
                    cardElement.className = `sensor-card ${data.status}`;
                } else {
                    valueElement.textContent = '--';
                    statusElement.textContent = 'Á≠âÂæÖÊï∞ÊçÆ';
                    cardElement.className = 'sensor-card';
                }
            }
        }

        function getStatusText(status) {
            const statusTexts = {
                'optimal': 'ÁêÜÊÉ≥',
                'good': 'ËâØÂ•Ω',
                'low': 'ÂÅè‰Ωé',
                'high': 'ÂÅèÈ´ò',
                'warning': 'Ë≠¶Âëä',
                'waiting': 'Á≠âÂæÖ'
            };
            return statusTexts[status] || 'Êú™Áü•';
        }

        function updateDetectionDisplay(data) {
            document.getElementById('totalDetections').textContent = data.stats?.total_detections || 0;
            document.getElementById('currentDetections').textContent = data.detection_count || 0;
            document.getElementById('processingTime').textContent = `${(data.stats?.processing_time || 0).toFixed(2)}s`;
            document.getElementById('currentImage').textContent = data.image_filename || '--';

            const badge = document.getElementById('detectionBadge');
            if (data.detection_count > 0) {
                badge.textContent = `Ê£ÄÊµãÂà∞ ${data.detection_count} ‰∏™Áâ©‰Ωì`;
                badge.style.background = '#28a745';
            } else {
                badge.textContent = 'Êú™Ê£ÄÊµãÂà∞Áâ©‰Ωì';
                badge.style.background = '#6c757d';
            }

            // üéØ Êõ¥Êñ∞ÈÄöÁî®Ê£ÄÊµãÁ±ªÂà´ÁªüËÆ°
            updateObjectCategories(data.detections || []);
            updateRecentDetections(data.detections || []);
        }

        // üéØ Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÈÄöÁî®Ê£ÄÊµãÁ±ªÂà´ÁªüËÆ°
        function updateObjectCategories(detections) {
            const categoriesContainer = document.getElementById('objectCategories');

            if (detections.length === 0) {
                categoriesContainer.innerHTML = `
                    <div class="no-detections" style="text-align: center; color: #666; font-size: 12px; padding: 10px;">
                        ÊöÇÊó†Ê£ÄÊµãÁªìÊûú
                    </div>
                `;
                return;
            }

            // ÁªüËÆ°ÂêÑÁ±ªÂà´Êï∞Èáè
            const categoryCounts = {};
            detections.forEach(detection => {
                const className = detection.class_name || 'unknown';
                categoryCounts[className] = (categoryCounts[className] || 0) + 1;
            });

            // ÁîüÊàêÁ±ªÂà´ÁªüËÆ°HTML
            let categoriesHTML = '';
            for (const [className, count] of Object.entries(categoryCounts)) {
                const categoryInfo = getObjectCategoryInfo(className);
                categoriesHTML += `
                    <div class="object-category-item ${categoryInfo.cssClass}">
                        <div class="category-icon">${categoryInfo.icon}</div>
                        <div class="category-name">${categoryInfo.displayName}</div>
                        <div class="category-count">${count}</div>
                    </div>
                `;
            }

            categoriesContainer.innerHTML = categoriesHTML;
        }

        // üéØ Êñ∞Â¢ûÔºöËé∑ÂèñÁâ©‰ΩìÁ±ªÂà´‰ø°ÊÅØ
        function getObjectCategoryInfo(className) {
            const categoryMap = {
                'person': { icon: 'üë§', displayName: '‰∫∫Âëò', cssClass: 'person' },
                'car': { icon: 'üöó', displayName: 'Ê±ΩËΩ¶', cssClass: 'car' },
                'truck': { icon: 'üöö', displayName: 'Âç°ËΩ¶', cssClass: 'car' },
                'bus': { icon: 'üöå', displayName: 'ÂÖ¨‰∫§ËΩ¶', cssClass: 'car' },
                'motorcycle': { icon: 'üèçÔ∏è', displayName: 'Êë©ÊâòËΩ¶', cssClass: 'car' },
                'bicycle': { icon: 'üö≤', displayName: 'Ëá™Ë°åËΩ¶', cssClass: 'car' },
                'bottle': { icon: 'üçº', displayName: 'Áì∂Â≠ê', cssClass: 'bottle' },
                'cup': { icon: '‚òï', displayName: 'ÊùØÂ≠ê', cssClass: 'bottle' },
                'chair': { icon: 'ü™ë', displayName: 'Ê§ÖÂ≠ê', cssClass: 'chair' },
                'couch': { icon: 'üõãÔ∏è', displayName: 'Ê≤ôÂèë', cssClass: 'chair' },
                'dining table': { icon: 'üçΩÔ∏è', displayName: 'È§êÊ°å', cssClass: 'chair' },
                'bed': { icon: 'üõèÔ∏è', displayName: 'Â∫ä', cssClass: 'chair' },
                'cell phone': { icon: 'üì±', displayName: 'ÊâãÊú∫', cssClass: 'phone' },
                'laptop': { icon: 'üíª', displayName: 'Á¨îËÆ∞Êú¨', cssClass: 'laptop' },
                'mouse': { icon: 'üñ±Ô∏è', displayName: 'Èº†Ê†á', cssClass: 'laptop' },
                'keyboard': { icon: '‚å®Ô∏è', displayName: 'ÈîÆÁõò', cssClass: 'laptop' },
                'tv': { icon: 'üì∫', displayName: 'ÁîµËßÜ', cssClass: 'laptop' },
                'book': { icon: 'üìö', displayName: '‰π¶Á±ç', cssClass: 'book' },
                'clock': { icon: '‚è∞', displayName: 'Êó∂Èíü', cssClass: 'book' },
                'vase': { icon: 'üè∫', displayName: 'Ëä±Áì∂', cssClass: 'book' },
                'potted plant': { icon: 'ü™¥', displayName: 'ÁõÜÊ†Ω', cssClass: 'book' },
                'dog': { icon: 'üêï', displayName: 'Áãó', cssClass: 'person' },
                'cat': { icon: 'üêà', displayName: 'Áå´', cssClass: 'person' },
                'bird': { icon: 'üê¶', displayName: 'È∏ü', cssClass: 'person' },
                'apple': { icon: 'üçé', displayName: 'ËãπÊûú', cssClass: 'bottle' },
                'banana': { icon: 'üçå', displayName: 'È¶ôËïâ', cssClass: 'bottle' },
                'orange': { icon: 'üçä', displayName: 'Ê©ôÂ≠ê', cssClass: 'bottle' },
                'broccoli': { icon: 'ü•¶', displayName: 'Ë•øÂÖ∞Ëä±', cssClass: 'bottle' },
                'carrot': { icon: 'ü•ï', displayName: 'ËÉ°ËêùÂçú', cssClass: 'bottle' }
            };

            return categoryMap[className] || {
                icon: 'üì¶',
                displayName: className.charAt(0).toUpperCase() + className.slice(1),
                cssClass: 'common'
            };
        }

        function updateRecentDetections(detections) {
            const list = document.getElementById('recentDetectionsList');
            if (detections.length === 0) {
                list.innerHTML = '<li>ÊöÇÊó†Ê£ÄÊµãÁªìÊûú</li>';
                return;
            }

            list.innerHTML = '';
            detections.slice(0, 5).forEach(detection => {
                const li = document.createElement('li');
                li.textContent = `${detection.class_name}: ${(detection.confidence * 100).toFixed(1)}%`;
                list.appendChild(li);
            });
        }

        function updateVideoFrame(data) {
            // üéØ Êõ¥Êñ∞ÈÄöÁî®Ê£ÄÊµãÈù¢ÊùøÔºàÂéüÂßãÂõæÂÉèÔºâ
            const videoFrame = document.getElementById('videoFrame');
            const placeholder = document.getElementById('videoPlaceholder');
            const overlay = document.getElementById('videoOverlay');
            const frameInfo = document.getElementById('frameInfo');
            const detectionCount = document.getElementById('detectionCount');

            // üçì Êõ¥Êñ∞ËçâËéìÊ£ÄÊµãÈù¢ÊùøÔºàÂéüÂßãÂõæÂÉèÔºâ
            const strawberryFrame = document.getElementById('strawberryFrame');
            const strawberryPlaceholder = document.getElementById('strawberryPlaceholder');
            const strawberryOverlay = document.getElementById('strawberryOverlay');
            const strawberryFrameInfo = document.getElementById('strawberryFrameInfo');
            const strawberryCount = document.getElementById('strawberryCount');

            if (data.frame) {
                // üéØ ÈÄöÁî®Ê£ÄÊµãÈù¢ÊùøÊòæÁ§∫ÂéüÂßãÂõæÂÉèÔºàÂ¶ÇÊûúÊ≤°ÊúâÂçïÁã¨ÁöÑÊ†áÊ≥®ÂõæÂÉèÔºâ
                videoFrame.src = 'data:image/jpeg;base64,' + data.frame;
                videoFrame.style.display = 'block';
                placeholder.style.display = 'none';
                overlay.style.display = 'block';

                frameInfo.textContent = `Frame: ${data.frame_count || 0}`;
                detectionCount.textContent = `Ê£ÄÊµã: ${data.general_detection_count || 0} ‰∏™Áâ©‰Ωì`;

                // üçì ËçâËéìÊ£ÄÊµãÈù¢ÊùøÊòæÁ§∫ÂéüÂßãÂõæÂÉèÔºàÂ¶ÇÊûúÊ≤°ÊúâÂçïÁã¨ÁöÑÊ†áÊ≥®ÂõæÂÉèÔºâ
                strawberryFrame.src = 'data:image/jpeg;base64,' + data.frame;
                strawberryFrame.style.display = 'block';
                strawberryPlaceholder.style.display = 'none';
                strawberryOverlay.style.display = 'block';

                strawberryFrameInfo.textContent = `üçì ${data.image_filename || 'unknown'}`;
                strawberryCount.textContent = `ËçâËéì: ${data.strawberry_count || 0} ‰∏™`;

                updateCameraStatus({status: 'online'});
            }
        }

        // üéØ Êñ∞Â¢ûÔºöÊõ¥Êñ∞ÈÄöÁî®Ê£ÄÊµãÊ†áÊ≥®ÂõæÂÉè
        function updateGeneralFrame(data) {
            const videoFrame = document.getElementById('videoFrame');
            const placeholder = document.getElementById('videoPlaceholder');
            const overlay = document.getElementById('videoOverlay');
            const frameInfo = document.getElementById('frameInfo');
            const detectionCount = document.getElementById('detectionCount');

            if (data.frame) {
                videoFrame.src = 'data:image/jpeg;base64,' + data.frame;
                videoFrame.style.display = 'block';
                placeholder.style.display = 'none';
                overlay.style.display = 'block';

                frameInfo.textContent = `üéØ Ê£ÄÊµãÊ†áÊ≥®: ${data.image_filename || 'unknown'}`;
                detectionCount.textContent = `Ê£ÄÊµã: ${data.detection_count || 0} ‰∏™Áâ©‰Ωì`;

                console.log('üéØ ÈÄöÁî®Ê£ÄÊµãÊ†áÊ≥®ÂõæÂÉèÂ∑≤Êõ¥Êñ∞');
            }
        }

        function updateSystemStatus(data) {
            const systemInfoList = document.getElementById('systemInfoList');
            systemInfoList.innerHTML = `
                <li>MQTT: ${data.mqtt_connected ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•'}</li>
                <li>ÈÄöÁî®Ê£ÄÊµã: ${data.detection_enabled ? 'Â∑≤ÂêØÁî®' : 'Êú™ÂêØÁî®'}</li>
                <li>ËçâËéìÊ£ÄÊµã: ${strawberryEnabled ? 'Â∑≤ÂêØÁî®' : 'Êú™ÂêØÁî®'}</li>
                <li>ÊµãËØïÊ®°Âºè: ${data.test_mode ? 'ÊòØ' : 'Âê¶'}</li>
                <li>AIÂä©Êâã: ${data.ai_enabled ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•'}</li>
            `;
        }

        function updateMQTTStatus(data) {
            const statusDot = document.getElementById('mqttStatus');
            const statusText = document.getElementById('mqttText');

            if (data.connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Â∑≤ËøûÊé•';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Êú™ËøûÊé•';
            }
        }

        function updateCameraStatus(data) {
            const statusDot = document.getElementById('cameraStatus');
            const statusText = document.getElementById('cameraText');

            if (data.status === 'online') {
                statusDot.classList.add('connected');
                statusText.textContent = 'Âú®Á∫ø';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Á¶ªÁ∫ø';
            }
        }

        function updateAIStatus(data) {
            const statusDot = document.getElementById('aiStatus');
            const statusText = document.getElementById('aiText');
            const badge = document.getElementById('aiBadge');

            if (data.enabled && data.status === 'connected') {
                statusDot.classList.add('connected');
                statusText.textContent = 'Â∑≤ËøûÊé•';
                badge.textContent = 'Â∑≤ËøûÊé•';
                badge.style.background = '#28a745';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'Êú™ËøûÊé•';
                badge.textContent = 'Êú™ËøûÊé•';
                badge.style.background = '#dc3545';
            }
        }

        function requestSystemInfo() {
            if (socket && socket.connected) {
                socket.emit('request_sensors');
                socket.emit('request_detections');
            }
        }

        // Âú®È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéËá™Âä®ËØ∑Ê±ÇËçâËéìÁä∂ÊÄÅ
        setTimeout(() => {
            requestStrawberryStatus();
        }, 3000);

        // ÂÆöÊúüÊõ¥Êñ∞ËçâËéìÁä∂ÊÄÅ
        setInterval(() => {
            if (strawberryEnabled) {
                // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÂÆöÊúüÁä∂ÊÄÅÊ£ÄÊü•
            }
        }, 30000); // ÊØè30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°

        console.log('üçì ÂÆåÊï¥ÁâàËçâËéìÊ£ÄÊµãÂâçÁ´Ø‰ª£Á†ÅÂ∑≤Âä†ËΩΩ');
    </script>
</body>
</html>